if(!window.CQ_Analytics){window.CQ_Analytics={};}
CQ_Analytics.Operator=(function(){return function(){};})();CQ_Analytics.Operator.IS="is";CQ_Analytics.Operator.EQUALS="equals";CQ_Analytics.Operator.NOT_EQUAL="notequal";CQ_Analytics.Operator.GREATER="greater";CQ_Analytics.Operator.GREATER_OR_EQUAL="greaterorequal";CQ_Analytics.Operator.OLDER="older";CQ_Analytics.Operator.OLDER_OR_EQUAL="olderorequal";CQ_Analytics.Operator.LESS="less";CQ_Analytics.Operator.LESS_OR_EQUAL="lessorequal";CQ_Analytics.Operator.YOUNGER="younger";CQ_Analytics.Operator.YOUNGER_OR_EQUAL="youngerorequal";CQ_Analytics.Operator.CONTAINS="contains";CQ_Analytics.Operator.BEGINS_WITH="beginswith";CQ_Analytics.OperatorActions=function(){var mapping={};var addOperator=function(name,text,operation){mapping[name]=[text,operation];};addOperator(CQ_Analytics.Operator.EQUALS,"equals","==");addOperator(CQ_Analytics.Operator.IS,"is","==");addOperator(CQ_Analytics.Operator.NOT_EQUAL,"is not equal to","!=");addOperator(CQ_Analytics.Operator.GREATER,"is greater than",">");addOperator(CQ_Analytics.Operator.GREATER_OR_EQUAL,"is equal to or greater than",">=");addOperator(CQ_Analytics.Operator.OLDER,"is older than",">");addOperator(CQ_Analytics.Operator.OLDER_OR_EQUAL,"is equal to or older than",">=");addOperator(CQ_Analytics.Operator.LESS,"is less than","<");addOperator(CQ_Analytics.Operator.LESS_OR_EQUAL,"is equal to or less than","<=");addOperator(CQ_Analytics.Operator.YOUNGER,"is younger than","<");addOperator(CQ_Analytics.Operator.YOUNGER_OR_EQUAL,"is equal to or younger than","<=");addOperator(CQ_Analytics.Operator.CONTAINS,"contains",function(s1,s2){if(s1){if(s2){s1=""+s1;s2=""+s2;return s1.toLowerCase().indexOf(s2.toLowerCase())!=-1;}
return true;}
return false;});addOperator(CQ_Analytics.Operator.BEGINS_WITH,"begins with",function(s1,s2){if(s1){if(s2){s1=""+s1;s2=""+s2;return s1.toLowerCase().indexOf(s2.toLowerCase())==0;}
return true;}
return false;});var getByIndex=function(op,index){if(mapping[op]&&mapping[op][index]){return mapping[op][index];}
return"";};var escapeQuote=function(str){if(str){str=str.replace(new RegExp("\\'","ig"),str);}
return str;};return{getText:function(operator){return getByIndex(operator,0);},setText:function(operator,newText){if(mapping[operator]&&mapping[operator][0]){mapping[operator][0]=newText;}},getOperation:function(operator){return getByIndex(operator,1);},operate:function(object,property,operator,value,valueFormat){try{if(object&&object[property]){var toEval="";var op=this.getOperation(operator);op=op?op:operator;var objectValue=CQ.shared.XSS.getXSSTablePropertyValue(object,property);if(typeof op=="function"){return op.call(this,objectValue,value,valueFormat);}else{if(valueFormat){toEval=valueFormat+"('"+objectValue+"') "+op+" "+valueFormat+"('"+value+"')";}else{var s1=escapeQuote(objectValue);var s2=escapeQuote(value);toEval="'"+s1+"' "+op+" '"+s2+"'";}
var b=eval(toEval);return b;}}}catch(e){}
return false;}};}();CQ_Analytics.Utils=new function(){return{registerDocumentEventHandler:function(event,func){var oldHandler=window.document[event];if(typeof window.document[event]!='function'){window.document[event]=func;}else{window.document[event]=function(e){if(oldHandler){oldHandler(e);}
func(e);};}},eventWrapper:function(func){return function(e){var keyCode,event;if(document.all){keyCode=window.event.keyCode;event=window.event;}else{keyCode=(typeof(e.which)!='undefined')?e.which:0;event=e;}
if(event){func(event,keyCode);}};},loadElement:function(url,elemId){$CQ("#"+elemId).load(url);},loadTeaserElement:function(url,elemId,pageName){var hbckup=$CQ("#"+elemId).css("height");var h=$CQ("#"+elemId).height();if(h>0){$CQ("#"+elemId).css("height",h);}
var showTeaser=function(text){if(text&&text!=""){var toInject=$CQ(text).css("display","none");$CQ("#"+elemId).html("");$CQ("#"+elemId).append(toInject);toInject.fadeIn(function(){if(hbckup&&hbckup!="0px"){$CQ("#"+elemId).css("height",hbckup);}});if(pageName&&pageName=="home"){startHomepage();}
else if(pageName&&pageName=="mypanera"){countRewards();}
else if(pageName&&pageName=="wifi"){startHomepage();}}else{if(hbckup&&hbckup!="0px"){$CQ("#"+elemId).css("height",hbckup);}}};var cacheTeaser=function(url,text){if(!CQ_Analytics.Utils.teasersCache){CQ_Analytics.Utils.teasersCache={};}
CQ_Analytics.Utils.teasersCache[url]=text;};var handleTeaser=function(){if(CQ_Analytics.Utils.teasersCache&&CQ_Analytics.Utils.teasersCache[url]){showTeaser(CQ_Analytics.Utils.teasersCache[url]);}else{CQ_Analytics.Utils.teasersLoading=CQ_Analytics.Utils.teasersLoading||{};if(CQ_Analytics.Utils.teasersLoading[url]){window.setTimeout(function(){CQ_Analytics.Utils.loadTeaserElement(url,elemId);},100);}else{CQ_Analytics.Utils.teasersLoading[url]=true;loadTeaser();}}};var loadTeaser=function(){var requestURL=url;var baseUrl=location.href;if(typeof CQ_CONTENT_PATH!="undefined"){baseUrl=CQ_CONTENT_PATH;}
var wcmMode=CQ.shared.HTTP.getParameter(baseUrl,"wcmmode");if(wcmMode){requestURL+=(requestURL.indexOf("?")>0?"&":"?")+"wcmmode="+wcmMode;}
CQ.shared.HTTP.get(requestURL,function(o,success,response){if(success){var text=response.body;if(text){text=text.replace(new RegExp("\\n","ig"),"");text=text.replace(new RegExp("\\r","ig"),"");cacheTeaser(url,text);delete CQ_Analytics.Utils.teasersLoading[url];handleTeaser();}}else{cacheTeaser(url,"");}});};var length=$CQ("#"+elemId).children().length;if(length>0){var item=0;$CQ("#"+elemId).children().fadeOut(function(){var child=$CQ(this);window.setTimeout(function(){child.remove();item++;if(item>=length){handleTeaser();}},50);});}else{handleTeaser();}},clearElement:function(elemId){if(elemId){$CQ("#"+elemId).html("");}},indexOf:function(array,o){for(var i=0,len=array.length;i<len;i++){if(array[i]==o){return i;}}
return-1;},load:function(url,callback,scope){return CQ.shared.HTTP.get(url,callback,scope);},post:function(url,callback,params,scope){return CQ.shared.HTTP.post(url,callback,params,scope);},getPagePath:function(){return CQ.shared.HTTP.getPath();},getPath:function(url){return CQ.shared.HTTP.getPath(url);},addParameter:function(url,name,value){return CQ.shared.HTTP.addParameter(url,name,value);},removeParameters:function(url){return CQ.shared.HTTP.removeParameters(url);},removeAnchor:function(url){return CQ.shared.HTTP.removeAnchor(url);},getSchemeAndAuthority:function(url){return CQ.shared.HTTP.getSchemeAndAuthority(url);},internalize:function(url,doc){return CQ.shared.HTTP.internalize(doc);},externalize:function(url,encode){return CQ.shared.HTTP.externalize(url,encode);},encodePathOfURI:function(url){return CQ.shared.HTTP.encodePathOfURI(url);},encodePath:function(path){return CQ.shared.HTTP.encodePath(path);},getContextPath:function(){return CQ.shared.HTTP.getContextPath();},detectContextPath:function(){return CQ.shared.HTTP.detectContextPath();},urlEncode:function(o){if(!o){return"";}
if(typeof o=='string'){return o;}
var buf=[];for(var key in o){var ov=o[key],k=encodeURIComponent(key);var type=typeof ov;if(type=='undefined'){buf.push(k,"=&");}else if(type!="function"&&type!="object"){buf.push(k,"=",encodeURIComponent(ov),"&");}else if(typeof ov=="array"){if(ov.length){for(var i=0,len=ov.length;i<len;i++){buf.push(k,"=",encodeURIComponent(ov[i]===undefined?'':ov[i]),"&");}}else{buf.push(k,"=&");}}}
buf.pop();return buf.join("");},getUID:function(){var r=Math.floor(Math.random()*(Math.pow(2,42)-1));return this.getTimestamp().toString(16)+r.toString(16);},getTimestamp:function(){var d=new Date();return d.getTime();},insert:function(str,every,separator){if(!str||isNaN(every)||!separator)return str;var res="";var from=0;var to=every;while(to<str.length){res+=str.substring(from,to)+separator;from+=every;to+=every;}
if(from<str.length){res+=str.substring(from);}
return res;},addListener:function(){if(window.addEventListener){return function(el,eventName,fn,capture){el.addEventListener(eventName,fn,(capture));};}else if(window.attachEvent){return function(el,eventName,fn,capture){el.attachEvent("on"+eventName,fn);};}else{return function(){};}},removeListener:function(){if(window.removeEventListener){return function(el,eventName,fn,capture){el.removeEventListener(eventName,fn,(capture));};}else if(window.detachEvent){return function(el,eventName,fn){el.detachEvent("on"+eventName,fn);};}else{return function(){};}}};};CQ_Analytics.ClickstreamcloudRenderingUtils=new function(){return{createLink:function(text,func,props,anchor){var link=document.createElement("a");link.href=anchor;link.onclick=func;link.innerHTML=text;if(props){for(var p in props){if(props.hasOwnProperty(p)){link[p]=props[p];}}}
return link;},createStaticLink:function(text,href,title){var link=document.createElement("a");link.href=href;link.innerHTML=text;link.title=title;link.alt=title;return link;},createNameValue:function(label,value,cssClass,title){var span=document.createElement("span");span.className=cssClass||"ccl-data";span.innerHTML=label+" = "+value;span.title=title;span.alt=title;return span;},createText:function(text,cssClass,title){var span=document.createElement("span");span.className=cssClass||"ccl-data";if(text&&text.indexOf&&((text.indexOf("/home")!=-1&&text.indexOf("/image")!=-1)||(text.indexOf("/")!=-1&&text.indexOf(".png")!=-1))){span.innerHTML="<img src=\""+text+".prof.thumbnail.png\" border=\"0\">";}
else if(text&&text.indexOf&&text.indexOf("www.gravatar.com")!=-1){span.innerHTML="<img src=\""+text+"\">";}
else{span.innerHTML=text;}
span.title=title;span.alt=title;return span;},createEditablePropertySpan:function(name,value){var onclick="var editSpan = this.nextSibling; "+"this.style.display = 'none'; "+"editSpan.style.display = 'block';";var onblur="var editSpan = this.parentNode; "+"var readSpan = this.parentNode.previousSibling;"+"var newValue = this.value;"+"editSpan.style.display = 'none'; "+"readSpan.innerHTML = '"+name+" = '+value; "+"readSpan.style.display = 'block';";var span=document.createElement("span");span.innerHTML="<span class=\"ccl-data\" onclick=\""+onclick+"\">"+name+" = "+value+"</span>";span.innerHTML+="<span class=\"ccl-data\" style=\"display: none;\">"+name+" = <input class=\"ccl-input\" type=\"text\" value=\""+value+"\" onblur=\""+onblur+"\"></span>";span.className="ccl-data";return span;}}};CQ_Analytics.ClientContextUtils=new function(){return{renderStoreProperty:function(id,storeName,propertyName,prefix,suffix,defaultValue){if(CQ_Analytics&&CQ_Analytics.CCM){CQ_Analytics.CCM.onReady(function(){var init=function(){var store=CQ_Analytics.StoreRegistry.getStore(storeName);if(store){var renderer=function(){var value=store.getProperty(propertyName)||defaultValue;var el=$CQ("#"+id);if(el.attr("contenteditable")&&el.attr("contenteditable")!="inherit")return;if(typeof(value)=="string"&&((value.indexOf("/")==0&&(value.toLowerCase().indexOf(".png")!=-1||value.toLowerCase().indexOf(".jpg")!=-1||value.toLowerCase().indexOf(".gif")!=-1)||value.toLowerCase().indexOf("http")==0))){if(!value||value==""){el.children().remove();if(CQ_Analytics.isUIAvailable){el.html(CQ.I18n.getMessage("No",null,"Ex: No address, No keywords")+" "+propertyName);}else{el.html("No "+propertyName);}}else{var url="";if(el.parents(".cq-cc-thumbnail").length==0||value.toLowerCase().indexOf("http")==0||value.indexOf("/libs/wcm/mobile")==0){url=value.replace(new RegExp("&amp;","g"),"&");}else{url="/etc/clientcontext/shared/thumbnail/content.png";url=CQ.shared.HTTP.addParameter(url,"path",CQ_Analytics.Variables.replaceVariables(value));}
url=CQ_Analytics.Variables.replaceVariables(url);if(el.find("div").css("background-image")!="url("+url+")"){if(store.fireEvent("beforepropertyrender",store,id)!==false){el.html("");el.children().remove();$CQ("<div>").addClass("cq-cc-thumbnail-img").css("background-image","url("+CQ.shared.HTTP.externalize(url)+")").appendTo(el);store.fireEvent("propertyrender",store,id);}}}}else{value=CQ_Analytics.Variables.replaceVariables(value);if(CQ_Analytics.isUIAvailable){value=(!value||value=="")?CQ.I18n.getMessage("No",null,"Ex: No address, No keywords")+" "+propertyName:value=prefix+value+suffix;}else{value=(!value||value=="")?"No "+propertyName:value=prefix+value+suffix;}
if(el.html()!=value){if(store.fireEvent("beforepropertyrender",store,id)!==false){el.html(value);store.fireEvent("propertyrender",store,id);}}}};if(store.fireEvent("beforeinitialpropertyrender",store,id)!==false){renderer();if(store.addListener){store.addListener('update',function(){renderer();});}
store.fireEvent("initialpropertyrender",store,id);}}};CQ_Analytics.ClientContextUtils.onStoreRegistered(storeName,init);});}},renderStore:function(id,storeName){if(CQ_Analytics&&CQ_Analytics.CCM&&id&&storeName){CQ_Analytics.CCM.onReady(function(){var init=function(){var store=CQ_Analytics.StoreRegistry.getStore(storeName);if(store){store.divId=id;var renderer=function(){if(store.fireEvent("beforerender",store,store.divId)!==false){store.renderer(store,store.divId);store.fireEvent("render",store,store.divId);}};if(store.fireEvent("beforeinitialrender",store,id)!==false){renderer();if(store.addListener){store.addListener('update',function(){renderer();});}
store.fireEvent("initialrender",store,id);}}};CQ_Analytics.ClientContextUtils.onStoreRegistered(storeName,init);});}},storesOptionsProvider:function(){var options=[];var stores=CQ_Analytics.StoreRegistry.getStores();for(var name in stores){options.push({value:name});}
return options;},storePropertiesOptionsProvider:function(storeName,showValue){var options=[];var store=CQ_Analytics.StoreRegistry.getStore(storeName);if(store){var names=store.getPropertyNames();for(var i=0;i<names.length;i++){var value=names[i];if(!CQ.shared.XSS.KEY_REGEXP.test(value)){var o={value:value};if(showValue){o["text"]=value+" - "+store.getProperty(value);}
options.push(o);}}}
return options;},onStoreRegistered:function(storeName,callback){if(callback){var store=CQ_Analytics.StoreRegistry.getStore(storeName);if(store){callback.call(store,store);}else{CQ_Analytics.CCM.addListener('storeregister',function(e,sessionstore){if(sessionstore.getName()==storeName){callback.call(sessionstore,sessionstore);}});}}},onStoreInitialized:function(storeName,callback,delay){if(delay===true){delay=CQ_Analytics.ClientContextUtils.DEFAULT_INIT_DELAY;}
var internal_callback=function(){var store=CQ_Analytics.StoreRegistry.getStore(storeName);if(store.DELAYED_INIT_TIMEOUT){window.clearTimeout(store.DELAYED_INIT_TIMEOUT);store.DELAYED_INIT_TIMEOUT=null;}
if(delay>0){store.DELAYED_INIT_TIMEOUT=window.setTimeout(function(){store.DELAYED_INIT_TIMEOUT=null;callback.call(store,"initialize",store);},delay);}else{callback.call(store,"initialize",store);}};var store=CQ_Analytics.StoreRegistry.getStore(storeName);if(store){if(store.isInitialized()){internal_callback.call(store);store.addListener("initialize",function(event,store){internal_callback.call(store);});}else{store.addListener("initialize",function(event,store){internal_callback.call(store);});}}else{CQ_Analytics.CCM.addListener('storeregister',function(e,sessionstore){if(sessionstore.getName()==storeName){CQ_Analytics.ClientContextUtils.onStoreInitialized(storeName,callback,delay);}});}},init:function(ccPath,pagePath){CQ_Analytics.ClientContextMgr.PATH=ccPath;CQ_Analytics.ClientContextMgr.loadConfig(null,true);var url=CQ.shared.HTTP.externalize(ccPath+"/content/jcr:content/stores.init.js");url=CQ.shared.HTTP.addParameter(url,"path",pagePath);url=CQ.shared.HTTP.noCaching(url);var res=CQ.shared.HTTP.get(url);},initUI:function(ccPath,pagePath){CQ_Analytics.ClientContextUI.create(ccPath,pagePath);}}};CQ_Analytics.ClientContextUtils.DEFAULT_INIT_DELAY=200;function countRewards(){var rewardsAnchor=$(".nav-rewards-ready label a");if(rewardsAnchor.length<=0){return;}
var displayRewards=(function(cnt){var cnt=parseInt(cnt);if(isNaN(cnt)||cnt<=0){$('#nav-rewards-empty').removeClass('hide');$('.nav-rewards-ready').addClass('hide');}else{$(".nav-rewards-ready label a").html(cnt);}});var user=$.cookie("info");var sso=$.cookie("ssoToken");var count=0;if(user!==null&&user!==undefined){var objects=SiteUtils.parseNVP(user);count=objects['rewards_count'];var cardNumber=objects['cardNumber'];if(count===undefined&&sso!==undefined&&sso!==null&&cardNumber!==null&&cardNumber!==undefined){$.getJSON('/panera/rewards/getrewards/'+objects['cardNumber']+"/"+sso).done(function(data){if(data!==null&&data!==undefined){count=data.length;}
else{count=0;}
user=user.concat(", rewards_count=").concat(count);$.cookie("info",user,{path:"/",domain:$("#sub_domain").val()});displayRewards(count);}).fail(function(){displayRewards(count);});}else{displayRewards(count);}}}
CQ_Analytics.Variables=new function(){return{containsVariable:function(value){return CQ_Analytics.Variables.getVariables(value).length>0;},getVariables:function(value){if(!value||typeof(value)!="string")return[];var res=value.match(new RegExp("\\$\\{([\\w/]*)\\}","ig"));return res?res:[];},replaceVariables:function(value){if(!value)return value;var history="";var res=value;var variables=CQ_Analytics.Variables.getVariables(value);while(variables.length>0&&history.indexOf(variables.join())==-1){for(var i=0;i<variables.length;i++){var vName=variables[i].substring(2,variables[i].length-1);var v=CQ_Analytics.ClientContext.get(vName)||"";res=CQ_Analytics.Variables.replace(res,vName,v);}
history+=variables.join();variables=CQ_Analytics.Variables.getVariables(res);}
return res;},replace:function(string,key,value){return string.replace(new RegExp("\\\$\\{"+key+"\\}","ig"),value);}}};CQ_Analytics.SessionPersistence=CQ.shared.ClientSidePersistence;CQ_Analytics.Cookie=CQ.shared.ClientSidePersistence.CookieHelper;CQ_Analytics.Observable=function(){this.fireEvent=function(event){if(event&&this.listeners&&!this.suppressEvents){event=event.toLowerCase();var args=Array.prototype.slice.call(arguments,0);var listenersCopy=this.listeners.slice(0);for(var i=0;i<listenersCopy.length;i++){var l=listenersCopy[i];if(event==l.event){if(l.fireFn.apply(l.scope||this||window,args)===false){return false;}}}}
return true;};};CQ_Analytics.Observable.prototype.addListener=function(event,fct,scope){this.listeners=this.listeners||new Array();if(event&&fct){this.listeners.push({"event":event.toLowerCase(),"fireFn":fct,"scope":scope});}};CQ_Analytics.Observable.prototype.removeListener=function(event,fct){this.listeners=this.listeners||new Array();if(event&&fct){for(var i=0;i<this.listeners.length;i++){if(this.listeners[i].event==event&&this.listeners[i].fireFn==fct){this.listeners.splice(i,1);}}}};CQ_Analytics.Observable.prototype.setSuppressEvents=function(suppressEvents){this.suppressEvents=suppressEvents;}
CQ_Analytics.Observable.prototype.listeners=null;CQ_Analytics.Observable.prototype.suppressEvents=false;if(!CQ_Analytics.StoreRegistry){CQ_Analytics.StoreRegistry=new function(){var stores={};return{register:function(store){if(store["STORENAME"]){stores[store.STORENAME]=store;}},getStores:function(){return stores;},getStore:function(name){return stores[name];}}}();}
CQ_Analytics.SessionStore=function(){};CQ_Analytics.SessionStore.prototype=new CQ_Analytics.Observable();CQ_Analytics.SessionStore.prototype.setProperty=function(name,value){if(this.data==null){this.init();}
this.data[name]=value;this.fireEvent("update",name);};CQ_Analytics.SessionStore.prototype.setProperties=function(properties){if(this.data==null){this.init();}
var names=[];for(var name in properties){if(properties.hasOwnProperty(name)){names.push(name);var value=properties[name];this.data[name]=value;}}
if(names.length>0){this.fireEvent("update",names);}};CQ_Analytics.SessionStore.prototype.initialized=false;CQ_Analytics.SessionStore.prototype.init=function(){this.initialized=true;this.fireEvent("initialize",this);};CQ_Analytics.SessionStore.prototype.getLabel=function(name){return name;};CQ_Analytics.SessionStore.prototype.getLink=function(name){return name;};CQ_Analytics.SessionStore.prototype.removeProperty=function(name){if(this.data==null){this.init();}
if(this.data[name]){delete this.data[name];}
this.fireEvent("update",name);};CQ_Analytics.SessionStore.prototype.getPropertyNames=function(excluded){if(this.data==null){this.init();}
excluded=excluded?excluded:[];var res=new Array();for(var p in this.data){if(CQ_Analytics.Utils.indexOf(excluded,p)==-1){res.push(p);}}
return res;};CQ_Analytics.SessionStore.prototype.getSessionStore=function(){return this;};CQ_Analytics.SessionStore.prototype.clear=function(){this.data=null;};CQ_Analytics.SessionStore.prototype.getData=function(excluded){if(this.data==null){this.init();}
if(excluded){var ret={};for(var p in this.data){if(CQ_Analytics.Utils.indexOf(excluded,p)==-1){ret[p]=this.data[p];}}
return ret;}else{return this.data;}};CQ_Analytics.SessionStore.prototype.reset=function(){if(this.data!=null){this.data=null;this.fireEvent("update");}};CQ_Analytics.SessionStore.prototype.getProperty=function(name,raw){if(this.data==null){this.init();}
var value=this.data[name];if(!raw){var xssValue=CQ.shared.XSS.getXSSValue(value);return xssValue;}
return value;};CQ_Analytics.SessionStore.prototype.getName=function(){return this.STORENAME;};CQ_Analytics.SessionStore.prototype.addInitProperty=function(name,value){if(!this.initProperty)this.initProperty={};this.initProperty[name]=value;};CQ_Analytics.SessionStore.prototype.getInitProperty=function(name){return this.initProperty?this.initProperty[name]:null;};CQ_Analytics.SessionStore.prototype.loadInitProperties=function(obj,setValues){if(obj){for(var p in obj){this.addInitProperty(p,obj[p]);if(setValues&&this.data&&this.data[p]===undefined){this.setProperty(p,obj[p]);}}}};CQ_Analytics.SessionStore.prototype.isInitialized=function(){return this.initialized;};CQ_Analytics.PersistedSessionStore=function(){};CQ_Analytics.PersistedSessionStore.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.PersistedSessionStore.prototype.STOREKEY="key";CQ_Analytics.PersistedSessionStore.prototype.setNonPersisted=function(name){if(!this.nonPersisted)this.nonPersisted={};this.nonPersisted[name]=true;};CQ_Analytics.PersistedSessionStore.EXCLUDED_PROPERTIES_REGEX="^generated*";CQ_Analytics.PersistedSessionStore.prototype.isPersisted=function(name){if(!this.nonPersisted)this.nonPersisted={};return this.nonPersisted[name]!==true&&!new RegExp(CQ_Analytics.PersistedSessionStore.EXCLUDED_PROPERTIES_REGEX,"ig").test(name)&&!$CQ.isFunction(this.data[name])&&(typeof this.data[name])!="object";};CQ_Analytics.PersistedSessionStore.prototype.getStoreKey=function(){return this.STOREKEY;};CQ_Analytics.PersistedSessionStore.prototype.persist=function(){if(this.fireEvent("beforepersist")!==false){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});store.set(this.getStoreKey(),this.toString());this.fireEvent("persist");}};CQ_Analytics.PersistedSessionStore.prototype.setProperty=function(name,value){if(this.data==null){this.init();}
this.data[name]=value;if(this.isPersisted(name)){this.persist();}
this.fireEvent("update",name);};CQ_Analytics.PersistedSessionStore.prototype.setProperties=function(properties){if(this.data==null){this.init();}
var names=[];var shouldPersist=false;for(var name in properties){if(properties.hasOwnProperty(name)){names.push(name);var value=properties[name];this.data[name]=value;if(this.isPersisted(name)){shouldPersist=true;}}}
if(shouldPersist){this.persist();}
if(names.length>0){this.fireEvent("update",names);}};CQ_Analytics.PersistedSessionStore.prototype.toString=function(){var list=null;if(this.data){var encodeCommandChars=function(value){if(!value||typeof(value)!="string")return value;var ret=value;ret=ret.replace(new RegExp(",","g"),"&#44;");ret=ret.replace(new RegExp("=","g"),"&#61;");ret=ret.replace(new RegExp("\\|","g"),"&#124;");return ret;};for(var p in this.data){if(this.isPersisted(p)&&this.data.hasOwnProperty(p)){list=(list===null?"":list+",");list+=(p+"="+encodeCommandChars(this.data[p]));}}}
return list;};CQ_Analytics.PersistedSessionStore.prototype.parse=function(str){var decodeCommandChars=function(value){if(!value||typeof(value)!="string")return value;var ret=value;ret=ret.replace(new RegExp("&#44;","g"),",");ret=ret.replace(new RegExp("&#61;","g"),"=");ret=ret.replace(new RegExp("&#124;","g"),"|");return ret;};var obj={};var array=str.split(",");for(var t in array){if(array.hasOwnProperty(t)){var entry=array[t].split("=");if(entry.length==2){obj[entry[0]]=decodeCommandChars(entry[1]);}}}
return obj;};CQ_Analytics.PersistedSessionStore.prototype.reset=function(deferEvent){if(this.data!=null){this.data={};this.persist();this.data=null;if(!deferEvent){this.fireEvent("update");}}};CQ_Analytics.PersistedSessionStore.prototype.removeProperty=function(name){if(this.data==null){this.init();}
if(this.data[name]){delete this.data[name];if(this.isPersisted(name)){this.persist();}}
this.fireEvent("update",name);};CQ_Analytics.PersistedSessionStore.prototype.clear=function(){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});store.remove(this.getStoreKey());this.data=null;};if(!CQ_Analytics.ClientContextMgr){CQ_Analytics.ClientContextMgr=function(){this.clientcontext=null;this.clientcontextToServer=null;this.stores={};this.data=null;this.config=null;this.isConfigLoaded=false;this.areStoresLoaded=false;};CQ_Analytics.ClientContextMgr.prototype=new CQ_Analytics.PersistedSessionStore();CQ_Analytics.ClientContextMgr.prototype.STOREKEY="CLIENTCONTEXT";CQ_Analytics.ClientContextMgr.prototype.STORENAME="clientcontext";CQ_Analytics.ClientContextMgr.prototype.INITIALIZATION_EVENT_TIMER=1000;CQ_Analytics.ClientContextMgr.prototype.CONFIG_PATH=CQ_Analytics.Utils.externalize("/etc/clientcontext/legacy/config.json",true);CQ_Analytics.ClientContextMgr.prototype.init=function(){if(!this.initialized){this.clientcontext={};this.clientcontextToServer={};}
var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});var value=store.get(this.getStoreKey());if(value){this.data=this.parse(value);}else{this.data={};}
this.initialized=true;this.fireEvent("initialize",this);};CQ_Analytics.ClientContextMgr.prototype.getSessionId=function(){if(!this.data["sessionId"]){this.setSessionId(CQ_Analytics.Utils.getUID());}
return this.data["sessionId"];};CQ_Analytics.ClientContextMgr.prototype.setSessionId=function(id){if(id){this.setProperty("sessionId",id);}};CQ_Analytics.ClientContextMgr.prototype.getVisitorId=function(){return this.data["visitorId"];};CQ_Analytics.ClientContextMgr.prototype.setVisitorId=function(id){this.setProperty("visitorId",id);};CQ_Analytics.ClientContextMgr.prototype.getId=function(){var id=this.getVisitorId();if(!id){return this.getSessionId();}
return id;};CQ_Analytics.ClientContextMgr.prototype.isAnonymous=function(){var id=this.getVisitorId();return(!id);};CQ_Analytics.ClientContextMgr.prototype.isMode=function(mode){return CQ_Analytics.ClientContextMgr.ServerStorage.isMode(mode);};CQ_Analytics.ClientContextMgr.prototype.get=function(toServer){if(this.clientcontext==null){this.init();}
if(toServer){return this.clientcontextToServer;}
return this.clientcontext;};CQ_Analytics.ClientContextMgr.prototype.register=function(sessionstore){if(this.clientcontext==null){this.init();}
var ccm=this;this.clientcontext[sessionstore.getName()]=sessionstore.getData();this.stores[sessionstore.getName()]=sessionstore;CQ_Analytics.StoreRegistry.register(sessionstore);var config=this.getStoreConfig(sessionstore.getName());if(config["stats"]!==false&&config["stats"]!="false"){this.clientcontextToServer[sessionstore.getName()]=sessionstore.getData(config["excludedFromStats"]);}
if(this.initTimer){window.clearTimeout(this.initTimer);this.initTimer=null;}
this.initTimer=window.setTimeout(function(){ccm.fireEvent("storesinitialize");ccm.areStoresInitialized=true;},this.INITIALIZATION_EVENT_TIMER);sessionstore.addListener("update",function(){ccm.update(sessionstore);});CQ_Analytics.ClientContextMgr.ServerStorage.handleStoreRegistration(sessionstore);this.addListener("clear",function(){sessionstore.clear();});this.fireEvent("storeregister",sessionstore);this.fireEvent("storeupdate",sessionstore);};CQ_Analytics.ClientContextMgr.prototype.update=function(sessionstore){if(this.clientcontext==null){this.init();}
this.clientcontext[sessionstore.getName()]=sessionstore.getData();var config=this.getStoreConfig(sessionstore.getName());if(config["stats"]!==false&&config["stats"]!="false"){this.clientcontextToServer[sessionstore.getName()]=sessionstore.getData(config["excludedFromStats"]);}
this.fireEvent("storeupdate",sessionstore);};CQ_Analytics.ClientContextMgr.prototype.startPosting=function(){return CQ_Analytics.ClientContextMgr.ServerStorage.startPosting();};CQ_Analytics.ClientContextMgr.prototype.stopPosting=function(){return CQ_Analytics.ClientContextMgr.ServerStorage.stopPosting();};CQ_Analytics.ClientContextMgr.prototype.post=function(){return CQ_Analytics.ClientContextMgr.ServerStorage.post();};CQ_Analytics.ClientContextMgr.prototype.getCCMToJCR=function(){return CQ_Analytics.ClientContextMgr.ServerStorage.getCCMToJCR();};CQ_Analytics.ClientContextMgr.prototype.getName=function(){return this.STORENAME;};CQ_Analytics.ClientContextMgr.prototype.clear=function(){this.clientcontext=null;this.clientcontextToServer=null;this.fireEvent("clear");};CQ_Analytics.ClientContextMgr.prototype.getRegisteredStore=function(name){return this.stores&&this.stores[name]?this.stores[name]:null;};CQ_Analytics.ClientContextMgr.prototype.loadConfig=function(c,autoConfig){var setConfig=function(ccm,config){ccm.config=config;ccm.isConfigLoaded=true;ccm.fireEvent("configloaded");ccm.fireEvent("storesloaded");ccm.areStoresLoaded=true;};if(c){setConfig(this,c);}else{if(!autoConfig){var params={};params["path"]=CQ_Analytics.Utils.getPagePath();params["cq_ck"]=new Date().valueOf();var url=this.CONFIG_PATH;url+="?"+CQ_Analytics.Utils.urlEncode(params);CQ_Analytics.Utils.load(url,function(data,status,response){var config={};try{config=eval("config = "+response.responseText);}catch(error){}
setConfig(this,config);},this);}else{setConfig(this,{});}}};CQ_Analytics.ClientContextMgr.prototype.getConfig=function(){return this.config;};CQ_Analytics.ClientContextMgr.prototype.getStoreConfig=function(storename){if(this.config&&this.config["configs"]&&this.config["configs"][storename]&&this.config["configs"][storename]["store"]){return this.config["configs"][storename]["store"];}
return{};};CQ_Analytics.ClientContextMgr.prototype.getEditConfig=function(storename){if(this.config&&this.config["configs"]&&this.config["configs"][storename]&&this.config["configs"][storename]["edit"]){return this.config["configs"][storename]["edit"];}
return{};};CQ_Analytics.ClientContextMgr.prototype.getUIConfig=function(storename){if(this.config&&this.config["configs"]&&this.config["configs"][storename]&&this.config["configs"][storename]["ui"]){return this.config["configs"][storename]["ui"];}
return{};};CQ_Analytics.ClientContextMgr.prototype.getInitialData=function(storename){if(this.config&&this.config["data"]&&this.config["data"][storename]){return this.config["data"][storename];}
return{};};CQ_Analytics.ClientContextMgr.prototype.getStores=function(){return this.stores;};CQ_Analytics.ClientContextMgr.prototype.onReady=function(callback,scope){if(callback){if(this.areStoresLoaded){callback.call(scope);}else{this.addListener("storesloaded",callback,scope);}}};CQ_Analytics.ClientContextMgr=CQ_Analytics.CCM=new CQ_Analytics.ClientContextMgr();CQ_Analytics.ClickstreamcloudMgr=CQ_Analytics.CCM;CQ_Analytics.ContextCloudMgr=CQ_Analytics.CCM;CQ_Analytics.ClientContextMgr.PATH=null;CQ_Analytics.ClientContextMgr.getClientContextURL=function(url){return CQ_Analytics.ClientContextMgr.PATH+url;};window.setTimeout(function(){CQ_Analytics.CCM.init();},1);CQ_Analytics.Utils.addListener(window,"unload",function(){try{for(var p in CQ_Analytics.ClientContextMgr){delete CQ_Analytics.ClientContextMgr[p];}
CQ_Analytics.ClientContextMgr=null;}catch(error){}
CQ_Analytics.CCM=null;});}
if(CQ_Analytics.ClientContextMgr&&!CQ_Analytics.ClientContextMgr.ServerStorage){CQ_Analytics.ClientContextMgr.ServerStorage=function(){this.posting=false;this.initialized=false;};CQ_Analytics.ClientContextMgr.ServerStorage.prototype.POST_MODE_PAGELOAD=0x1;CQ_Analytics.ClientContextMgr.ServerStorage.prototype.POST_MODE_TIMER=0x2;CQ_Analytics.ClientContextMgr.ServerStorage.prototype.POST_MODE_DATAUPDATE=0x4;CQ_Analytics.ClientContextMgr.ServerStorage.prototype.POST_TIMER=600;CQ_Analytics.ClientContextMgr.ServerStorage.prototype.POST_PROCESS_TIMER=60;CQ_Analytics.ClientContextMgr.ServerStorage.prototype.POST_MODE=0x6;CQ_Analytics.ClientContextMgr.ServerStorage.prototype.POST_PATH="/var/statistics/";CQ_Analytics.ClientContextMgr.ServerStorage.prototype.init=function(){if(this.isMode(CQ_Analytics.ClientContextMgr.ServerStorage.POST_MODE_TIMER)){var currentObj=this;var func=function(){currentObj.timer=window.setInterval(function(){try{var lastPost=parseInt(currentObj.data["lastPost"]);var doPost=false;if(isNaN(lastPost)){doPost=true;}else{var currentTime=new Date().getTime();if(currentTime>lastPost+CQ_Analytics.ClientContextMgr.ServerStorage.POST_TIMER*1000){doPost=true;}}}catch(error){}
if(doPost){currentObj.post();}},CQ_Analytics.ClientContextMgr.ServerStorage.POST_PROCESS_TIMER*1000);};func.call(this);}
this.initialized=true;};CQ_Analytics.ClientContextMgr.ServerStorage.prototype.isMode=function(mode){return(CQ_Analytics.CCM.POST_MODE&mode)>0;};CQ_Analytics.ClientContextMgr.ServerStorage.prototype.handleStoreRegistration=function(sessionstore){if(!this.initialized){this.init();}
if(this.isMode(CQ_Analytics.ClientContextMgr.ServerStorage.POST_MODE_DATAUPDATE)){sessionstore.addListener("persist",function(){CQ_Analytics.ClientContextMgr.ServerStorage.post(sessionstore);});}};CQ_Analytics.ClientContextMgr.ServerStorage.prototype.startPosting=function(){this.posting=true;};CQ_Analytics.ClientContextMgr.ServerStorage.prototype.stopPosting=function(){this.posting=false;};CQ_Analytics.ClientContextMgr.ServerStorage.prototype.post=function(storeName,forced){if(this.posting||forced){try{var obj=this.getCCMToJCR(storeName);var currentTime=CQ_Analytics.Utils.getTimestamp();obj["./jcr:primaryType"]="nt:unstructured";obj["./sessionId"]=CQ_Analytics.CCM.getSessionId();var url=this.POST_PATH+"clientcontext/";if(CQ_Analytics.CCM.isAnonymous()){var sessionSplit=CQ_Analytics.Utils.insert(CQ_Analytics.CCM.getId(),2,"/");url+="anonymous/"+sessionSplit+"/"+currentTime;}else{url+="users/"+CQ_Analytics.CCM.getId()+"/"+currentTime;}
CQ_Analytics.Utils.post(url,null,obj);this.lastPost=currentTime;}catch(error){}}};CQ_Analytics.ClientContextMgr.ServerStorage.prototype.getCCMToJCR=function(storeName){var obj=CQ_Analytics.CCM.get(true);var resObj={};for(var key in obj){if(!storeName||key==storeName){var ov=obj[key],k=encodeURIComponent(key);var type=typeof ov;if(type=='object'){for(var l2key in ov){var v=ov[l2key];l2key=l2key.replace(":","/");resObj["./"+key+"/./"+l2key]=v;}}else{resObj["./"+key]=ov;}}}
return resObj;};CQ_Analytics.ClientContextMgr.ServerStorage=new CQ_Analytics.ClientContextMgr.ServerStorage();CQ_Analytics.ClickstreamcloudMgr.POST_MODE_PAGELOAD=CQ_Analytics.ClientContextMgr.ServerStorage.POST_MODE_PAGELOAD;CQ_Analytics.ClickstreamcloudMgr.POST_MODE_TIMER=CQ_Analytics.ClientContextMgr.ServerStorage.POST_MODE_TIMER;CQ_Analytics.ClickstreamcloudMgr.POST_MODE_DATAUPDATE=CQ_Analytics.ClientContextMgr.ServerStorage.POST_MODE_DATAUPDATE;CQ_Analytics.ClickstreamcloudMgr.POST_TIMER=CQ_Analytics.ClientContextMgr.ServerStorage.POST_PROCESS_TIMER;CQ_Analytics.ClickstreamcloudMgr.POST_PROCESS_TIMER=CQ_Analytics.ClientContextMgr.ServerStorage.POST_PROCESS_TIMER;CQ_Analytics.ClickstreamcloudMgr.POST_MODE=CQ_Analytics.ClientContextMgr.ServerStorage.POST_MODE;CQ_Analytics.ClickstreamcloudMgr.POST_PATH=CQ_Analytics.ClientContextMgr.ServerStorage.POST_PATH;}
CQ_Analytics.Percentile={};CQ_Analytics.Percentile.matchesPercentiles=function(percentiles){var percentileValue=ClientContext.get("/surferinfo/percentile");if(!percentileValue){percentileValue=Math.round(Math.random()*100);ClientContext.set("/surferinfo/percentile",percentileValue);}
for(var i=0;i<percentiles.length;i++){var percentile=percentiles[i];if((percentile.start<=percentileValue)&&(percentileValue<percentile.end))
return true;}
return false;}
if(!CQ_Analytics.SegmentMgr){CQ_Analytics.SegmentMgr=function(){this.SEGMENTATION_ROOT="/etc/segmentation";this.SEGMENT_SELECTOR=".segment.js";this.SEGMENTATION_SCRIPT_LOADER="cq-segmentation-loader";this.segments={};this.boosts={};var currentObj=this;this.fireUpdate=function(){currentObj.fireEvent("update");};this.init();};CQ_Analytics.SegmentMgr.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.SegmentMgr.prototype.STORENAME="segments";CQ_Analytics.SegmentMgr.prototype.register=function(segmentPath,rule,boost){this.segments[segmentPath]=rule;this.boosts[segmentPath]=!isNaN(boost)?parseInt(boost):0;this.fireUpdate();};CQ_Analytics.SegmentMgr.prototype.resolveArray=function(segmentPaths,clientcontext,operator){clientcontext=clientcontext||CQ_Analytics.ClientContextMgr.get();if(!(segmentPaths instanceof Array)){return this.resolve(segmentPaths,clientcontext);}
operator=(operator=="AND"?"AND":"OR");var finalRes=(operator=="AND");for(var i=0;i<segmentPaths.length;i++){var s=segmentPaths[i];var res=this.resolve(s,clientcontext);if(operator=="AND"){if(res!==true)return res;}else{if(res===true)return true;}}
return finalRes;};CQ_Analytics.SegmentMgr.prototype.resolve=function(segmentPath,clientcontext){clientcontext=clientcontext||CQ_Analytics.ClientContextMgr.get();if(!segmentPath)return false;if(segmentPath instanceof Array)return this.resolveArray(segmentPath,clientcontext);if(segmentPath.indexOf(this.SEGMENTATION_ROOT)!=0)return false;if(segmentPath==this.SEGMENTATION_ROOT)return true;if(!this.segments[segmentPath])return true;var parent=segmentPath.substring(0,segmentPath.lastIndexOf("/"));if(parent.indexOf(this.SEGMENTATION_ROOT)==0){var pres=this.resolve(parent,clientcontext);if(pres!==true)return pres;}
var rules="function(clientcontext, contextcloud, clickstreamcloud) { return true ";rules+=" && ( "+this.segments[segmentPath]+" ) ";rules+=";}";var res=true;try{var f=null;eval("f = "+rules+"");var e=(f==null||f(clientcontext,clientcontext,clientcontext));res=res&&(e===true);}catch(error){return"Unresolved - Error while evaluating segment "+segmentPath+" : "+error.message;}
return res;};CQ_Analytics.SegmentMgr.prototype.getResolved=function(clientcontext){clientcontext=clientcontext||CQ_Analytics.ClientContextMgr.get();var res=new Array();for(var path in this.segments){if(this.resolve(path,clientcontext)===true){res.push(path);}}
return res;};CQ_Analytics.SegmentMgr.prototype.getMaxBoost=function(segmentPaths,clientcontext){if(!(segmentPaths instanceof Array)){return this.getBoost(segmentPaths);}
var boost=0;for(var i=0;i<segmentPaths.length;i++){var s=segmentPaths[i];if(this.resolve(s,clientcontext)===true){var b=this.boosts[s]||0;if(b>boost){boost=b;}}}
return boost;};CQ_Analytics.SegmentMgr.prototype.getBoost=function(segmentPath){if(!(segmentPath instanceof Array)){segmentPath=[segmentPath];}
return this.boosts[segmentPath]||0;};CQ_Analytics.SegmentMgr.prototype.reload=function(path){var url=path;if(!url){url=this.SEGMENTATION_ROOT;}
if(url){if(url.indexOf(this.SEGMENT_SELECTOR)==-1)url+=this.SEGMENT_SELECTOR;try{CQ_Analytics.Utils.load(url,function(config,status,response){if(response&&response.responseText){eval(response.responseText);}},this);var response=CQ.HTTP.get(scripts[i].src);}catch(err){}}};CQ_Analytics.SegmentMgr.prototype.getSessionStore=function(){return this;};CQ_Analytics.SegmentMgr.prototype.getProperty=function(name){return name;};CQ_Analytics.SegmentMgr.prototype.getLink=function(name){return name+".html";};CQ_Analytics.SegmentMgr.prototype.getLabel=function(name){if(name){var label=name;var index=label.lastIndexOf("/");if(index!=-1){label=label.substring(index+1,label.length);}
var res=this.resolve(name);if(res===true){return label;}else{if(res!==true){return"<span class=\"invalid\" title=\""+res+"\" alt=\""+res+"\">"+label+"</span>";}}}
return name;};CQ_Analytics.SegmentMgr.prototype.getPropertyNames=function(){return this.getResolved();};CQ_Analytics.SegmentMgr=new CQ_Analytics.SegmentMgr();CQ_Analytics.SegmentMgr.loadSegments=function(path){CQ_Analytics.SegmentMgr.areSegmentsLoaded=false;CQ.shared.HTTP.get(CQ.shared.HTTP.externalize(path+".segment.js"));CQ_Analytics.SegmentMgr.areSegmentsLoaded=true;this.fireEvent("segmentsload");};CQ_Analytics.SegmentMgr.renderer=function(store,targetId){if(store&&store.STORENAME==CQ_Analytics.SegmentMgr.STORENAME){var props=store.getPropertyNames();var div=$CQ("<div>");for(var i=0;i<props.length;i++){var name=props[i];div.append($CQ("<span>").attr("title",store.getProperty(name)).append($CQ("<a>").attr("href",CQ.shared.HTTP.externalize(store.getLink(name))).attr("title",store.getProperty(name)).html(store.getLabel(name))));}
$CQ("#"+targetId).children().remove();$CQ("#"+targetId).append(div);}};CQ_Analytics.ClientContextMgr.addListener("storeupdate",CQ_Analytics.SegmentMgr.fireUpdate);CQ_Analytics.Utils.addListener(window,"unload",function(){try{for(var p in CQ_Analytics.SegmentMgr){delete CQ_Analytics.SegmentMgr[p];}}catch(error){}
CQ_Analytics.SegmentMgr=null;});}
if(!CQ_Analytics.StrategyMgr){CQ_Analytics.StrategyMgr=function(){this.strategies={};};CQ_Analytics.StrategyMgr.prototype={};CQ_Analytics.StrategyMgr.prototype.isRegistered=function(strategy){return!!this.strategies[strategy];};CQ_Analytics.StrategyMgr.prototype.register=function(strategy,func){if(typeof func=='function'){this.strategies[strategy]=func;}};CQ_Analytics.StrategyMgr.prototype.choose=function(strategy,teasers){if(teasers.length==1)return teasers[0];if(this.strategies[strategy]){return this.strategies[strategy].call(this,teasers);}};CQ_Analytics.StrategyMgr=new CQ_Analytics.StrategyMgr();}
CQ_Analytics.StrategyMgr.register("clickstream-score",function(teasers){if(teasers.length==1){return teasers[0];}
var selectedTeasers=[];if(CQ_Analytics.TagCloudMgr){var tags=CQ_Analytics.TagCloudMgr.getTags();tags=tags||{};var selectedTeasersWeight=-1;for(var i=0;i<teasers.length;i++){var currentTeaserWeight=0;var teaserTags=teasers[i].tags;if(teaserTags){for(var j=0;j<teaserTags.length;j++){var tagID=teaserTags[j].tagID;currentTeaserWeight+=parseInt(tags[tagID])||0;}}
if(currentTeaserWeight==selectedTeasersWeight){selectedTeasers.push(teasers[i]);}else{if(currentTeaserWeight>selectedTeasersWeight){selectedTeasers=[];selectedTeasers.push(teasers[i]);selectedTeasersWeight=currentTeaserWeight;}}}}else{selectedTeasers=teasers;}
if(selectedTeasers.length==1){return selectedTeasers[0];}
var random=null;if(CQ_Analytics.PageDataMgr){random=CQ_Analytics.PageDataMgr.getProperty("random");}
if(!random){random=window.CQ_StrategyRandom;}
if(!random){random=window.CQ_StrategyRandom=Math.random();}
if(parseFloat(random)>1){random=1/random;}
if(parseFloat(random)==1){random=0;}
var ranNum=Math.floor(random*selectedTeasers.length);return selectedTeasers[ranNum];});CQ_Analytics.StrategyMgr.register("first",function(teasers){return teasers[0];});CQ_Analytics.StrategyMgr.register("random",function(teasers){var random=null;if(CQ_Analytics.PageDataMgr){random=CQ_Analytics.PageDataMgr.getProperty("random");}
if(!random){random=window.CQ_StrategyRandom;}
if(!random){random=window.CQ_StrategyRandom=Math.random();}
if(parseFloat(random)>1){random=1/random;}
if(parseFloat(random)==1){random=0;}
var ranNum=Math.floor(random*teasers.length);return teasers[ranNum];});if(!CQ_Analytics.PageDataMgr){CQ_Analytics.PageDataMgr=function(){};CQ_Analytics.PageDataMgr.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.PageDataMgr.prototype.STORENAME="pagedata";CQ_Analytics.PageDataMgr.prototype.FORCE_EXPERIENCE_COOKIE="cq-forceexperience";CQ_Analytics.PageDataMgr.prototype.init=function(){this.data={};for(var p in this.initProperty){this.data[p]=this.initProperty[p];}
this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.PageDataMgr.prototype.getLabel=function(name){return name;};CQ_Analytics.PageDataMgr.prototype.getLink=function(name){return"";};CQ_Analytics.PageDataMgr.prototype.setExperience=function(path){CQ.shared.HTTP.setCookie(CQ_Analytics.PageDataMgr.FORCE_EXPERIENCE_COOKIE,path,"/");};CQ_Analytics.PageDataMgr.prototype.getExperience=function(){return CQ.shared.HTTP.getCookie(CQ_Analytics.PageDataMgr.FORCE_EXPERIENCE_COOKIE,"/");};CQ_Analytics.PageDataMgr.prototype.clearExperience=function(){CQ.shared.HTTP.clearCookie(CQ_Analytics.PageDataMgr.FORCE_EXPERIENCE_COOKIE,"/");};CQ_Analytics.PageDataMgr=new CQ_Analytics.PageDataMgr();CQ_Analytics.CCM.addListener("configloaded",function(){this.loadInitProperties(CQ_Analytics.CCM.getInitialData(this.getName()));this.init();CQ_Analytics.CCM.register(this);},CQ_Analytics.PageDataMgr);}
CQ_Analytics.BrowserInfo=function(){var ua=navigator.userAgent.toLowerCase();var check=function(r){return r.test(ua);};var getBrowser=function(){if(check(/opera/)){return{browserFamily:"Opera",browserVersion:""};}
if(check(/chrome/)){return{browserFamily:"Chrome",browserVersion:""};}
if(check(/safari/)){if(check(/applewebkit\/4/)){return{browserFamily:"Safari",browserVersion:"2"};}
if(check(/version\/3/)){return{browserFamily:"Safari",browserVersion:"3"};}
if(check(/version\/4/)){return{browserFamily:"Safari",browserVersion:"4"};}
if(check(/version\/5/)){return{browserFamily:"Safari",browserVersion:"5"};}
if(check(/version\/6/)){return{browserFamily:"Safari",browserVersion:"6"};}
return{browserFamily:"Safari",browserVersion:"7 or higher"};}
if(check(/webkit/)){return{browserFamily:"WebKit",browserVersion:""};}
if(check(/msie/)){if(check(/msie 6/)){return{browserFamily:"IE",browserVersion:"6"};}
if(check(/msie 7/)){return{browserFamily:"IE",browserVersion:"7"};}
if(check(/msie 8/)){return{browserFamily:"IE",browserVersion:"8"};}
if(check(/msie 9/)){return{browserFamily:"IE",browserVersion:"9"};}
if(check(/msie 10/)){return{browserFamily:"IE",browserVersion:"10"};}
return{browserFamily:"IE",browserVersion:"11 or higher"};}
if(check(/gecko/)){if(check(/rv:1\.8/)){return{browserFamily:"Firefox",browserVersion:"2"};}
if(check(/rv:1\.9/)){return{browserFamily:"Firefox",browserVersion:"3"};}
if(check(/rv:2.0/)){return{browserFamily:"Firefox",browserVersion:"4"};}
if(check(/rv:5./)){return{browserFamily:"Firefox",browserVersion:"5"};}
if(check(/rv:6./)){return{browserFamily:"Firefox",browserVersion:"6"};}
if(check(/rv:7./)){return{browserFamily:"Firefox",browserVersion:"7"};}
if(check(/rv:8./)){return{browserFamily:"Firefox",browserVersion:"8"};}
if(check(/rv:9./)){return{browserFamily:"Firefox",browserVersion:"9"};}
return{browserFamily:"Firefox",browserVersion:"10 or higher"};}
var isAir=check(/adobeair/);if(isAir){return{browserFamily:"Adobe AIR",browserVersion:""};}
return{browserFamily:"Unresolved",browserVersion:"Unresolved"};};var getOS=function(){if(check(/windows 98|win98/)){return"Windows 98";}
if(check(/windows nt 5.0|windows 2000/)){return"Windows 2000";}
if(check(/windows nt 5.1|windows xp/)){return"Windows XP";}
if(check(/windows nt 5.2/)){return"Windows Server 2003";}
if(check(/windows nt 6.0/)){return"Windows Vista";}
if(check(/windows nt 6.1/)){return"Windows 7";}
if(check(/windows nt 4.0|winnt4.0|winnt/)){return"Windows NT 4.0";}
if(check(/windows me/)){return"Windows ME";}
if(check(/mac os x/)){if(check(/ipad/)||check(/iphone/)){return"iOS";}
return"Mac OS X";}
if(check(/macintosh|mac os/)){return"Mac OS";}
if(check(/android/)){return"Android";}
if(check(/linux/)){return"Linux";}
return"Unresolved";};var getDeviceType=function(){if(check(/ipad/)){return"iPad";}
if(check(/iphone/)){return"iPhone";}
if(check(/mobi/)){return"Mobile";}
return"Desktop";};var b=getBrowser.call();this.browserFamily=b.browserFamily;this.browserVersion=b.browserVersion;this.OSName=getOS.call();this.deviceType=getDeviceType.call();this.ua=ua;var isSecure=/^https/i.test(window.location.protocol);this.screenResolution=screen.width+"x"+screen.height;};CQ_Analytics.BrowserInfo.prototype={getBrowserName:function(){return this.browserFamily+" "+this.browserVersion;},getBrowserFamily:function(){return this.browserFamily;},getBrowserVersion:function(){return this.browserVersion;},getOSName:function(){return this.OSName;},getScreenResolution:function(){return this.screenResolution;},getDeviceType:function(){return this.deviceType;},getUserAgent:function(){return this.ua;},isMobile:function(deviceType){if(!deviceType){deviceType=this.getDeviceType();}
deviceType=deviceType?deviceType.toLowerCase():"desktop";return deviceType!="desktop";},isIE:function(version){return this.getBrowserFamily()=="IE"&&(version?this.getBrowserVersion()==version:true);},isIE6:function(){return this.isIE("6");},isIE7:function(){return this.isIE("7");},isIE8:function(){return this.isIE("8");},isIE9:function(){return this.isIE("9");}};CQ_Analytics.BrowserInfoInstance=new CQ_Analytics.BrowserInfo();if(!CQ_Analytics.MousePositionMgr){CQ_Analytics.MousePositionMgr=function(){this.position={"x":0,"y":0};this.getPageX=function(ev){var x=ev.pageX;if(!x&&0!==x){x=ev.clientX||0;}
return x;};this.getPageY=function(ev){var y=ev.pageY;if(!y&&0!==y){y=ev.clientY||0;}
return y;};var currentObj=this;this.timer=null;$CQ(document).bind("mousemove",function(event,a,b,c){var e=event||window.event;if(e){if(!currentObj.timer){var x=currentObj.getPageX(e);var y=currentObj.getPageY(e);currentObj.timer=setTimeout(function(){currentObj.setPosition(x,y);currentObj.timer=null;},500);}}});this.init();};CQ_Analytics.MousePositionMgr.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.MousePositionMgr.prototype.STORENAME="mouseposition";CQ_Analytics.MousePositionMgr.prototype.setPosition=function(x,y){this.position["x"]=x;this.position["y"]=y;this.fireEvent("update");};CQ_Analytics.MousePositionMgr.prototype.getProperty=function(name){return this.position[name];};CQ_Analytics.MousePositionMgr.prototype.getLabel=function(name){return name;};CQ_Analytics.MousePositionMgr.prototype.getLink=function(name){return"";};CQ_Analytics.MousePositionMgr.prototype.getPropertyNames=function(){var res=new Array();for(var p in this.position){res.push(p);}
return res;};CQ_Analytics.MousePositionMgr.prototype.getSessionStore=function(){return this;};CQ_Analytics.MousePositionMgr.prototype.getData=function(excluded){return this.position;};CQ_Analytics.MousePositionMgr.prototype.clear=function(){this.position={};};CQ_Analytics.MousePositionMgr=new CQ_Analytics.MousePositionMgr();CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);},CQ_Analytics.MousePositionMgr);}
if(!CQ_Analytics.EventDataMgr){CQ_Analytics.EventDataMgr=function(){};CQ_Analytics.EventDataMgr.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.EventDataMgr.prototype.STORENAME="eventdata";CQ_Analytics.EventDataMgr.prototype.init=function(){this.data={};for(var p in this.initProperty){this.data[p]=this.initProperty[p];}
this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.EventDataMgr.prototype.getLabel=function(name){return name;};CQ_Analytics.EventDataMgr.prototype.getLink=function(name){return"";};CQ_Analytics.EventDataMgr=new CQ_Analytics.EventDataMgr();CQ_Analytics.CCM.addListener("configloaded",function(){this.loadInitProperties(CQ_Analytics.CCM.getInitialData(this.getName()));this.init();CQ_Analytics.CCM.register(this);},CQ_Analytics.EventDataMgr);}
if(!window.CQ_Context){window.CQ_Context=function(){};window.CQ_Context.prototype=new CQ_Analytics.Observable();window.CQ_Context.prototype.getProfile=function(){return(function(){return{getUserId:function(){return this.getProperty("authorizableId");},getDisplayName:function(){var fn=this.getProperty("formattedName");if(fn)return fn;fn=this.getProperty("displayName");if(fn)return fn;return this.getUserId();},getFirstname:function(){return this.getProperty("givenName");},getLastname:function(){return this.getProperty("familyName");},getEmail:function(){return this.getProperty("email");},getProperty:function(name){if(CQ_Analytics&&CQ_Analytics.ProfileDataMgr){return CQ_Analytics.ProfileDataMgr.getProperty(name);}
return"";},getProperties:function(){if(CQ_Analytics&&CQ_Analytics.ProfileDataMgr){return CQ_Analytics.ProfileDataMgr.getData();}
return{};},getAvatar:function(){return this.getProperty("avatar");},onUpdate:function(fct,scope){if(fct&&CQ_Analytics&&CQ_Analytics.ProfileDataMgr){CQ_Analytics.ProfileDataMgr.addListener("update",fct,scope||this);}}}})();};window.CQ_Context=new window.CQ_Context();}
window.CQ_trackTeasersStats=true;if(typeof String.prototype.trim!=='function'){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,'');}}
function initializeTeaserLoader(allTeasers,strategyName,targetElementId,isEditMode,trackingURL,editablePath,pageName){isEditMode=!!(CQ.Ext&&(isEditMode=="true"||isEditMode===true));if(window.CQ_Analytics){var toExecute=function(){var TEASER_SUFFIX="/_jcr_content/par.html";if(isEditMode){TEASER_SUFFIX+="?wcmmode=disabled";}
var forceExp=CQ_Analytics.PageDataMgr.getExperience();if(forceExp){CQ_Analytics.PageDataMgr.clearExperience();CQ_Analytics.Utils.loadElement(forceExp+TEASER_SUFFIX,targetElementId);return;}
var computeDecisionHTML=function(teaserPath){var html="";var teasers=new Array();if(CQ_Analytics.SegmentMgr){var lastBoost=0;for(var i=0;i<allTeasers.length;i++){var p=CQ.shared.HTTP.externalize(allTeasers[i].path+".html");if(!allTeasers[i]["segments"]||allTeasers[i]["segments"].length==0||CQ_Analytics.SegmentMgr.resolveArray(allTeasers[i]["segments"])===true){var boost=CQ_Analytics.SegmentMgr.getMaxBoost(allTeasers[i]["segments"]);var params=[allTeasers[i]["title"],boost,allTeasers[i].thumbnail,p];if(teaserPath==allTeasers[i].path){html+=CQ.I18n.getMessage("<b><a href=\"{3}\" class=\"cq-teaser-segment-link\"><img src=\"{2}\" class=\"cq-teaser-decision-thumbnail cq-teaser-decision-match\"></a>Experience: {0} - match ( boost = {1} )</b><br>",params);}else{html+=CQ.I18n.getMessage("<a href=\"{3}\" class=\"cq-teaser-segment-link\"><img src=\"{2}\" class=\"cq-teaser-decision-thumbnail cq-teaser-decision-match\"></a>Experience: {0} - match ( boost = {1} )<br>",params);}
if(boost==lastBoost){teasers.push(allTeasers[i]);}else{if(boost>lastBoost){teasers=new Array();teasers.push(allTeasers[i]);lastBoost=boost;}}}else{var params=[allTeasers[i]["title"],allTeasers[i].thumbnail,p];html+=CQ.I18n.getMessage("<a href=\"{2}\" class=\"cq-teaser-segment-link\"><img src=\"{1}\" class=\"cq-teaser-decision-thumbnail cq-teaser-decision-nomatch\"></a>Experience: {0} - no match<br>",params);}}}
html+=CQ.I18n.getMessage("<br>Strategy <b>{0}</b> selected current teaser.<br>",strategyName);return html;};var currentVisibleTeaser=null;var ttip=null;var loadTeasers=function(){var teasers=new Array();if(CQ_Analytics.SegmentMgr){var lastBoost=0;for(var i=0;i<allTeasers.length;i++){if(!allTeasers[i]["segments"]||allTeasers[i]["segments"].length==0||CQ_Analytics.SegmentMgr.resolveArray(allTeasers[i]["segments"])===true){var boost=CQ_Analytics.SegmentMgr.getMaxBoost(allTeasers[i]["segments"]);if(boost==lastBoost){teasers.push(allTeasers[i]);}else{if(boost>lastBoost){teasers=new Array();teasers.push(allTeasers[i]);lastBoost=boost;}}}}}
if(teasers.length>0){var teaserToShow=teasers[0];if(CQ_Analytics.StrategyMgr){var teas=CQ_Analytics.StrategyMgr.choose(strategyName,teasers);if(teas!=null){teaserToShow=teas;}}
if(!currentVisibleTeaser||currentVisibleTeaser.path!=teaserToShow.path){currentVisibleTeaser=teaserToShow;var url=teaserToShow.path+TEASER_SUFFIX;url=CQ.shared.HTTP.addSelectors(url,CQ.shared.HTTP.getSelectors(window.location.href));CQ_Analytics.Utils.loadTeaserElement(url,targetElementId,pageName);CQ_Analytics.Utils.loadTeaserElement(url,targetElementId);if(window.CQ_trackTeasersStats&&trackingURL){if(!CQ_Analytics.loadedTeasersStack){CQ_Analytics.loadedTeasersStack=[];$CQ(window).unload(function(){try{var loadedTeasers=CQ_Analytics.loadedTeasersStack;if(loadedTeasers){delete CQ_Analytics.loadedTeasersStack;var url=trackingURL;for(var i=0;i<loadedTeasers.length;i++){url=CQ.shared.HTTP.addParameter(url,"path",loadedTeasers[i]);}
CQ.shared.HTTP.get(url,function(){});}}catch(error){}});}
CQ_Analytics.loadedTeasersStack.push(teaserToShow.path);}
if(isEditMode){if(editablePath){var editable=CQ.WCM.getEditable(editablePath);if(editable){if(editable&&editable.teaserToolTip){editable.teaserToolTip.hide();editable.teaserToolTip.remove();editable.teaserToolTip=null;}else{editable.on(CQ.wcm.EditRollover.EVENT_SHOW_HIGHTLIGHT,function(highlight){if(!this.teaserInfoButton){this.teaserInfoButton=CQ.Ext.DomHelper.append('CQ',{tag:'div',cls:'x-tool x-tool-help cq-teaser-tooltip-tool'},true);this.teaserInfoButton.position("absolute");this.teaserInfoButton.on("click",function(){if(!editable.teaserToolTip){editable.teaserToolTip=new CQ.Ext.Tip({"html":computeDecisionHTML(currentVisibleTeaser.path),"title":CQ.I18n.getMessage("Selection decision"),"width":450,"autoHide":false,"closable":true,"height":300,"floating":true,"autoHeight":false,"bodyStyle":"overflow-y: scroll;"});}
var pos=this.getXY();editable.teaserToolTip.setPosition(pos[0]-460,pos[1]-100);editable.teaserToolTip.show();});}
this.teaserInfoButton.anchorTo(highlight.frameBottom.getEl(),"tr",[-26,-15]);this.teaserInfoButton.show();});editable.on(CQ.wcm.EditRollover.EVENT_HIDE_HIGHTLIGHT,function(highlight){if(this.teaserInfoButton){this.teaserInfoButton.hide();}});}}}}}}else{if(isEditMode){var editable=CQ.WCM.getEditable(editablePath);if(editable&&editable.teaserToolTip){editable.teaserToolTip.hide();editable.teaserToolTip.remove();editable.teaserToolTip=null;}}
CQ_Analytics.Utils.clearElement(targetElementId);currentVisibleTeaser=null;}};loadTeasers.call();if(CQ_Analytics.SegmentMgr){CQ_Analytics.SegmentMgr.addListener("update",loadTeasers);}};if(CQ_Analytics.CCM.areStoresInitialized){toExecute.call(this);}else{CQ_Analytics.CCM.addListener("storesinitialize",toExecute);}}}
function initializeTeaserHome(allTeasers,strategyName,targetElementId,isEditMode,trackingURL,editablePath,pageName){isEditMode=!!(CQ.Ext&&(isEditMode=="true"||isEditMode===true));if(window.CQ_Analytics){var toExecute=function(){var TEASER_SUFFIX="/_jcr_content/par.html";if(isEditMode){TEASER_SUFFIX+="?wcmmode=disabled";}
var forceExp=CQ_Analytics.PageDataMgr.getExperience();if(forceExp){CQ_Analytics.PageDataMgr.clearExperience();CQ_Analytics.Utils.loadElement(forceExp+TEASER_SUFFIX,targetElementId);return;}
var computeDecisionHTML=function(teaserPath){var html="";var teasers=new Array();if(CQ_Analytics.SegmentMgr){var lastBoost=0;for(var i=0;i<allTeasers.length;i++){var p=CQ.shared.HTTP.externalize(allTeasers[i].path+".html");if(!allTeasers[i]["segments"]||allTeasers[i]["segments"].length==0||CQ_Analytics.SegmentMgr.resolveArray(allTeasers[i]["segments"])===true){var boost=CQ_Analytics.SegmentMgr.getMaxBoost(allTeasers[i]["segments"]);var params=[allTeasers[i]["title"],boost,allTeasers[i].thumbnail,p];if(teaserPath==allTeasers[i].path){html+=CQ.I18n.getMessage("<b><a href=\"{3}\" class=\"cq-teaser-segment-link\"><img src=\"{2}\" class=\"cq-teaser-decision-thumbnail cq-teaser-decision-match\"></a>Experience: {0} - match ( boost = {1} )</b><br>",params);}else{html+=CQ.I18n.getMessage("<a href=\"{3}\" class=\"cq-teaser-segment-link\"><img src=\"{2}\" class=\"cq-teaser-decision-thumbnail cq-teaser-decision-match\"></a>Experience: {0} - match ( boost = {1} )<br>",params);}
if(boost==lastBoost){teasers.push(allTeasers[i]);}else{if(boost>lastBoost){teasers=new Array();teasers.push(allTeasers[i]);lastBoost=boost;}}}else{var params=[allTeasers[i]["title"],allTeasers[i].thumbnail,p];html+=CQ.I18n.getMessage("<a href=\"{2}\" class=\"cq-teaser-segment-link\"><img src=\"{1}\" class=\"cq-teaser-decision-thumbnail cq-teaser-decision-nomatch\"></a>Experience: {0} - no match<br>",params);}}}
html+=CQ.I18n.getMessage("<br>Strategy <b>{0}</b> selected current teaser.<br>",strategyName);return html;};var currentVisibleTeaser=null;var ttip=null;var loadTeasers=function(){var teasers=new Array();if(CQ_Analytics.SegmentMgr){var lastBoost=0;for(var i=0;i<allTeasers.length;i++){if(!allTeasers[i]["segments"]||allTeasers[i]["segments"].length==0||CQ_Analytics.SegmentMgr.resolveArray(allTeasers[i]["segments"])===true){var boost=CQ_Analytics.SegmentMgr.getMaxBoost(allTeasers[i]["segments"]);if(boost==lastBoost){teasers.push(allTeasers[i]);}else{if(boost>lastBoost){teasers=new Array();teasers.push(allTeasers[i]);lastBoost=boost;}}}}}
if(teasers.length>0){var teaserToShow=teasers[0];if(CQ_Analytics.StrategyMgr){var teas=CQ_Analytics.StrategyMgr.choose(strategyName,teasers);if(teas!=null){teaserToShow=teas;}}
if(!currentVisibleTeaser||currentVisibleTeaser.path!=teaserToShow.path){currentVisibleTeaser=teaserToShow;var url=teaserToShow.path+TEASER_SUFFIX;url=CQ.shared.HTTP.addSelectors(url,CQ.shared.HTTP.getSelectors(window.location.href));CQ_Analytics.Utils.loadTeaserElement(url,targetElementId,pageName);if(window.CQ_trackTeasersStats&&trackingURL){if(!CQ_Analytics.loadedTeasersStack){CQ_Analytics.loadedTeasersStack=[];$CQ(window).unload(function(){try{var loadedTeasers=CQ_Analytics.loadedTeasersStack;if(loadedTeasers){delete CQ_Analytics.loadedTeasersStack;var url=trackingURL;for(var i=0;i<loadedTeasers.length;i++){url=CQ.shared.HTTP.addParameter(url,"path",loadedTeasers[i]);}
CQ.shared.HTTP.get(url,function(){});}}catch(error){}});}
CQ_Analytics.loadedTeasersStack.push(teaserToShow.path);}
if(isEditMode){if(editablePath){var editable=CQ.WCM.getEditable(editablePath);if(editable){if(editable&&editable.teaserToolTip){editable.teaserToolTip.hide();editable.teaserToolTip.remove();editable.teaserToolTip=null;}else{editable.on(CQ.wcm.EditRollover.EVENT_SHOW_HIGHTLIGHT,function(highlight){if(!this.teaserInfoButton){this.teaserInfoButton=CQ.Ext.DomHelper.append('CQ',{tag:'div',cls:'x-tool x-tool-help cq-teaser-tooltip-tool'},true);this.teaserInfoButton.position("absolute");this.teaserInfoButton.on("click",function(){if(!editable.teaserToolTip){editable.teaserToolTip=new CQ.Ext.Tip({"html":computeDecisionHTML(currentVisibleTeaser.path),"title":CQ.I18n.getMessage("Selection decision"),"width":450,"autoHide":false,"closable":true,"height":300,"floating":true,"autoHeight":false,"bodyStyle":"overflow-y: scroll;"});}
var pos=this.getXY();editable.teaserToolTip.setPosition(pos[0]-460,pos[1]-100);editable.teaserToolTip.show();});}
this.teaserInfoButton.anchorTo(highlight.frameBottom.getEl(),"tr",[-26,-15]);this.teaserInfoButton.show();});editable.on(CQ.wcm.EditRollover.EVENT_HIDE_HIGHTLIGHT,function(highlight){if(this.teaserInfoButton){this.teaserInfoButton.hide();}});}}}}}}else{if(isEditMode){var editable=CQ.WCM.getEditable(editablePath);if(editable&&editable.teaserToolTip){editable.teaserToolTip.hide();editable.teaserToolTip.remove();editable.teaserToolTip=null;}}
CQ_Analytics.Utils.clearElement(targetElementId);currentVisibleTeaser=null;}};loadTeasers.call();if(CQ_Analytics.SegmentMgr){CQ_Analytics.SegmentMgr.addListener("update",loadTeasers);}};if(CQ_Analytics.CCM.areStoresInitialized){toExecute.call(this);}else{CQ_Analytics.CCM.addListener("storesinitialize",toExecute);}}}
window.CQ_trackLandingPagesStats=true;function initializeLandingPageLoader(allLandingPages,strategyName,targetElementId,isEditMode,trackingURL){isEditMode=CQ.Ext&&(isEditMode=="true"||isEditMode===true);if(window.CQ_Analytics){var LANDINGPAGE_SUFFIX=".html";var toExecute=function(){var currentVisibleLandingPage=null;var loadLandingPages=function(){var landingPages=new Array();if(CQ_Analytics.SegmentMgr){var lastBoost=0;for(var i=0;i<allLandingPages.length;i++){if(!allLandingPages[i]["segments"]||allLandingPages[i]["segments"].length==0||CQ_Analytics.SegmentMgr.resolveArray(allLandingPages[i]["segments"])===true){var boost=CQ_Analytics.SegmentMgr.getMaxBoost(allLandingPages[i]["segments"]);if(boost==lastBoost){landingPages.push(allLandingPages[i]);}else{if(boost>lastBoost){landingPages=new Array();landingPages.push(allLandingPages[i]);lastBoost=boost;}}}}}
if(landingPages.length>0){var landingPageToShow=landingPages[0];if(CQ_Analytics.StrategyMgr){var lp=CQ_Analytics.StrategyMgr.choose(strategyName,landingPages);if(lp!=null){landingPageToShow=lp;}}
if(!currentVisibleLandingPage||currentVisibleLandingPage.path!=landingPageToShow.path){var previousLandingPage=currentVisibleLandingPage;currentVisibleLandingPage=landingPageToShow;var request=CQ.shared.HTTP.get(landingPageToShow.path+LANDINGPAGE_SUFFIX);var text=request.responseText;var extractDiv=function(text,id){var ret="";if(text&&text.indexOf("id=\""+id+"\"")!=-1){var index=text.indexOf("id=\""+id+"\"");var oDivIndex=text.substring(0,index).lastIndexOf("<div");var tmp=text.substring(oDivIndex);var split=tmp.split(new RegExp("<div","ig"));var opened=0;for(var i=0;i<split.length;i++){opened++;var split2=split[i].split(new RegExp("</div","ig"));for(var j=1;j<split2.length;j++){opened--;if(opened==1){var cDivIndex=split[i].lastIndexOf("</div")+6;cDivIndex=tmp.indexOf(split[i])+cDivIndex;tmp=tmp.substring(0,cDivIndex);tmp=tmp.substring(tmp.indexOf(">")+1,tmp.lastIndexOf("</div"));return tmp;}}}}
return"";};text=extractDiv(text,targetElementId);var target=$CQ("#"+targetElementId)[0];var removeEditables=function(filter,show){if(isEditMode){var editables=CQ.WCM.getEditables();for(var epath in editables){var editable=editables[epath];if(!filter||editable.path.indexOf(filter)!=-1){editable.hide();editable.remove();}}}};var node=document.createElement("div");node.innerHTML=text;if(previousLandingPage){$CQ("object",target).parent().fadeOut("slow");$CQ("img",target).fadeOut("slow");$CQ(target).slideUp("slow",function(){removeEditables(previousLandingPage.path,false);$CQ(target).children().remove();var toInject=target.insertBefore(node,target.firstChild);$CQ(target).slideDown("slow",function(){if(isEditMode){CQ.DOM.executeScripts(CQ.Ext.get(node));}});});}else{var toInject=target.insertBefore(node,target.firstChild);$CQ(target).slideDown("slow",function(){if(isEditMode){CQ.DOM.executeScripts(CQ.Ext.get(node));}});}
try{if(window.CQ_trackLandingPagesStats&&trackingURL){if(!CQ_Analytics.loadedLandingPagesStack){CQ_Analytics.loadedLandingPagesStack=[];$CQ(window).unload(function(){try{var loadedLandingPages=CQ_Analytics.loadedLandingPagesStack;if(loadedLandingPages){delete CQ_Analytics.loadedLandingPagesStack;var url=trackingURL;for(var i=0;i<loadedLandingPages.length;i++){url=CQ.shared.HTTP.addParameter(url,"path",loadedLandingPages[i]);}
CQ.shared.HTTP.get(url,function(){});}}catch(error){}});}
CQ_Analytics.loadedLandingPagesStack.push(landingPageToShow.path);}}catch(error){}}}else{CQ_Analytics.Utils.clearElement(targetElementId);currentVisibleLandingPage=null;}};loadLandingPages.call();if(CQ_Analytics.SegmentMgr){CQ_Analytics.SegmentMgr.addListener("update",loadLandingPages);}};if(CQ_Analytics.ClickstreamcloudMgr){if(CQ_Analytics.ClickstreamcloudMgr.areStoresLoaded){toExecute.call(this);}else{CQ_Analytics.ClickstreamcloudMgr.addListener("storesloaded",toExecute);}}}}
CQ_Analytics.PersistedJSONStore=function(){};CQ_Analytics.PersistedJSONStore.prototype=new CQ_Analytics.PersistedSessionStore();CQ_Analytics.PersistedJSONStore.prototype.STOREKEY="";CQ_Analytics.PersistedJSONStore.prototype.STORENAME="";CQ_Analytics.PersistedJSONStore.prototype.init=function(){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});var value=store.get(this.getStoreKey());if(!value||value==""){this.data={};for(var p in this.initProperty){this.data[p]=this.initProperty[p];}}else{this.data=this.parse(value);}
this.persist();this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.PersistedJSONStore.prototype.clear=function(){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});store.remove(this.getStoreKey());this.data=null;this.initProperty={};};CQ_Analytics.PersistedJSONStore.prototype.initJSON=function(jsonData,doNotClear){if(!doNotClear){this.initProperty={};}
var propertyToPaths=function(target,prefix,obj){for(var p in obj){if(typeof obj[p]=="object"){propertyToPaths(target,prefix?prefix+"/"+p:p,obj[p]);}else{target[prefix?prefix+"/"+p:p]=obj[p];}}};propertyToPaths(this.initProperty,null,jsonData);};CQ_Analytics.PersistedJSONStore.prototype.getJSON=function(){var data=this.getData();var res={};for(var longProp in data){var s=longProp.split("/");var level=res;for(var i=0;i<s.length;i++){var propLevel=s[i];if(i==s.length-1){level[propLevel]=data[longProp];}else{level[propLevel]=level[propLevel]||{};level=level[propLevel];}}}
return res;};CQ_Analytics.PersistedJSONStore.getInstance=function(storeName,jsonData){var s=new CQ_Analytics.PersistedJSONStore();s.STOREKEY=storeName.toUpperCase();s.STORENAME=storeName;s.initJSON(jsonData);return s;};CQ_Analytics.PersistedJSONStore.registerNewInstance=function(storeName,jsonData){var jsonStore=CQ_Analytics.PersistedJSONStore.getInstance(storeName,jsonData);jsonStore.init();CQ_Analytics.CCM.register(jsonStore);return jsonStore;};CQ_Analytics.JSONStore=function(){};CQ_Analytics.JSONStore.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.JSONStore.prototype.STOREKEY="";CQ_Analytics.JSONStore.prototype.STORENAME="";CQ_Analytics.JSONStore.prototype.init=function(){this.data={};for(var p in this.initProperty){this.data[p]=this.initProperty[p];}
this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.JSONStore.prototype.clear=function(){this.data=null;this.initProperty={};};CQ_Analytics.JSONStore.prototype.initJSON=function(jsonData,doNotClear){if(!doNotClear){this.initProperty={};}
var propertyToPaths=function(target,prefix,obj){for(var p in obj){if(typeof obj[p]=="object"){propertyToPaths(target,prefix?prefix+"/"+p:p,obj[p]);}else{target[prefix?prefix+"/"+p:p]=obj[p];}}};propertyToPaths(this.initProperty,null,jsonData);};CQ_Analytics.JSONStore.prototype.getJSON=function(){var data=this.getData();var res={};for(var longProp in data){var s=longProp.split("/");var level=res;for(var i=0;i<s.length;i++){var propLevel=s[i];if(i==s.length-1){level[propLevel]=data[longProp];}else{level[propLevel]=level[propLevel]||{};level=level[propLevel];}}}
return res;};CQ_Analytics.JSONStore.getInstance=function(storeName,jsonData){var s=new CQ_Analytics.JSONStore();s.STOREKEY=storeName.toUpperCase();s.STORENAME=storeName;s.initJSON(jsonData);return s;};CQ_Analytics.JSONStore.registerNewInstance=function(storeName,jsonData){var jsonStore=CQ_Analytics.JSONStore.getInstance(storeName,jsonData);jsonStore.init();CQ_Analytics.CCM.register(jsonStore);return jsonStore;};CQ_Analytics.PersistedJSONPStore=function(){};CQ_Analytics.PersistedJSONPStore.prototype=new CQ_Analytics.PersistedJSONStore();CQ_Analytics.PersistedJSONPStore.prototype.setServiceURL=function(serviceURL){this.serviceURL=serviceURL;};CQ_Analytics.PersistedJSONPStore.prototype.getServiceURL=function(){return this.serviceURL;};CQ_Analytics.PersistedJSONPStore.prototype.load=function(serviceURL,dynamicData,callback){var storeName=this.getName();if(!CQ_Analytics.PersistedJSONPStore.JSONPCallbacks[this.getName()]){CQ_Analytics.PersistedJSONPStore.JSONPCallbacks[storeName]=function(data){var s=CQ_Analytics.CCM.getRegisteredStore(storeName);if(s){s.initJSON(data);if(dynamicData){s.initJSON(dynamicData,true);}}
if(callback){callback.call(s);}};}
if(serviceURL){this.setServiceURL(serviceURL);}
var url=this.serviceURL;url=url.replace("\$\{callback\}","CQ_Analytics.PersistedJSONPStore.JSONPCallbacks."+storeName);$CQ.getScript(url);};CQ_Analytics.PersistedJSONPStore.JSONPCallbacks={};CQ_Analytics.PersistedJSONPStore.getInstance=function(storeName,serviceURL,dynamicData,deferLoading,loadingCallback){if(storeName&&serviceURL){try{var jsonpStore=new CQ_Analytics.PersistedJSONPStore();jsonpStore.STOREKEY=storeName.toUpperCase();jsonpStore.STORENAME=storeName;if(serviceURL){jsonpStore.setServiceURL(serviceURL);}
if(!deferLoading){jsonpStore.load(serviceURL,dynamicData,loadingCallback);}
return jsonpStore;}catch(error){console.log("Cannot create the JSONP store",storeName,serviceURL,error);}}
return null;};CQ_Analytics.PersistedJSONPStore.registerNewInstance=function(storeName,serviceURL,dynamicData,callback){if(!serviceURL){return null;}
if(!storeName){var sa=CQ.shared.HTTP.getSchemeAndAuthority(serviceURL);if(sa){if(sa.indexOf(".")!=-1){sa=sa.substring(0,sa.lastIndexOf("."));storeName=sa.substring(sa.lastIndexOf(".")+1);}else{storeName=sa.substring(sa.lastIndexOf("/")+1);}}else{storeName=serviceURL;}}
var store=CQ_Analytics.PersistedJSONPStore.getInstance(storeName,serviceURL,dynamicData,false,function(){this.init();this.reset();if(callback){callback.call(this);}});if(store!=null){CQ_Analytics.CCM.register(store);return store;}
return null;};CQ_Analytics.JSONPStore=function(){};CQ_Analytics.JSONPStore.prototype=new CQ_Analytics.JSONStore();CQ_Analytics.JSONPStore.prototype.setServiceURL=function(serviceURL){this.serviceURL=serviceURL;};CQ_Analytics.JSONPStore.prototype.getServiceURL=function(){return this.serviceURL;};CQ_Analytics.JSONPStore.prototype.load=function(serviceURL,dynamicData,callback){var storeName=this.getName();if(!CQ_Analytics.JSONPStore.JSONPCallbacks[this.getName()]){CQ_Analytics.JSONPStore.JSONPCallbacks[storeName]=function(data){var s=CQ_Analytics.CCM.getRegisteredStore(storeName);if(s){s.initJSON(data);if(dynamicData){s.initJSON(dynamicData,true);}}
if(callback){callback.call(s);}};}
if(serviceURL){this.setServiceURL(serviceURL);}
var url=this.serviceURL;url=url.replace("\$\{callback\}","CQ_Analytics.JSONPStore.JSONPCallbacks."+storeName);$CQ.getScript(url);};CQ_Analytics.JSONPStore.JSONPCallbacks={};CQ_Analytics.JSONPStore.getInstance=function(storeName,serviceURL,dynamicData,deferLoading,loadingCallback){if(storeName){try{var jsonpStore=new CQ_Analytics.JSONPStore();jsonpStore.STOREKEY=storeName.toUpperCase();jsonpStore.STORENAME=storeName;if(serviceURL){jsonpStore.setServiceURL(serviceURL);if(!deferLoading){jsonpStore.load(serviceURL,dynamicData,loadingCallback);}}
return jsonpStore;}catch(error){console.log("Cannot create the JSONP store",storeName,serviceURL,error);}}
return null;};CQ_Analytics.JSONPStore.registerNewInstance=function(storeName,serviceURL,dynamicData,callback){if(!storeName&&serviceURL){var sa=CQ.shared.HTTP.getSchemeAndAuthority(serviceURL);if(sa){if(sa.indexOf(".")!=-1){sa=sa.substring(0,sa.lastIndexOf("."));storeName=sa.substring(sa.lastIndexOf(".")+1);}else{storeName=sa.substring(sa.lastIndexOf("/")+1);}}else{storeName=serviceURL;}}
var store=CQ_Analytics.JSONPStore.getInstance(storeName,serviceURL,dynamicData,false,function(){this.init();this.reset();if(callback){callback.call(this);}});if(store!=null){CQ_Analytics.CCM.register(store);return store;}
return null;};CQ_Analytics.record=function(options){if(options.collect){return[options.event,options.values];}else{if(options.event){options.options=options.options||{};try{CQ_Analytics.recordBeforeCallbacks.sort(function(a,b){return a.rank-b.rank;});for(var callback in CQ_Analytics.recordBeforeCallbacks){if(CQ_Analytics.recordBeforeCallbacks[callback].func.call(this,options)){return;}}}catch(err){}
var dataMgr=options.dataMgr||CQ_Analytics.EventDataMgr
dataMgr.reset();if(typeof options.event=="string"){dataMgr.setProperty("events",options.event);}else{dataMgr.setProperty("events",options.event.join("\u2026"));}
if(options.values){for(var j in options.values){var store=dataMgr;var prop=j.split('.');if(j.indexOf('.')>=0&&CQ_Analytics.StoreRegistry.getStore(prop[0])){store=CQ_Analytics.StoreRegistry.getStore(prop[0]);prop=prop[1];}
store.setProperty(prop,options.values[j]);}}
try{CQ_Analytics.recordAfterCallbacks.sort(function(a,b){return a.rank-b.rank;});for(var callback in CQ_Analytics.recordAfterCallbacks){if(CQ_Analytics.recordAfterCallbacks[callback].func.call(this,options)){return;}}}catch(err){}}}};CQ_Analytics.recordBeforeCallbacks=[];CQ_Analytics.recordAfterCallbacks=[];CQ_Analytics.registerBeforeCallback=function(callback,rank){CQ_Analytics.recordBeforeCallbacks.push({rank:rank,func:callback});};CQ_Analytics.registerAfterCallback=function(callback,rank){CQ_Analytics.recordAfterCallbacks.push({rank:rank,func:callback});};if(!CQ_Analytics.ClientContext){CQ_Analytics.ClientContext=new function(){return{get:function(path,resolveVariables){if(path){if(path.indexOf("/")!=0){path="/"+path;}
var storeName=path.split("/")[1];var propertyName=path.substring(path.indexOf("/"+storeName)+storeName.length+2,path.length);var store=CQ_Analytics.CCM.getRegisteredStore(storeName);if(store){if(propertyName){var value=store.getProperty(propertyName);if(value&&resolveVariables){value=CQ_Analytics.Variables.replaceVariables(value);}
return value;}
return store;}}
return null;},set:function(path,value){if(path){if(path.indexOf("/")!=0){path="/"+path;}
var storeName=path.split("/")[1];var propertyName=path.substring(path.indexOf("/"+storeName)+storeName.length+2,path.length);var store=CQ_Analytics.CCM.getRegisteredStore(storeName);if(store){if(propertyName){store.setProperty(propertyName,value);}}}},clear:function(){var stores=CQ_Analytics.CCM.getStores();if(stores){for(var s in stores){if(stores[s].clear){stores[s].clear();}}}},reset:function(){var stores=CQ_Analytics.CCM.getStores();if(stores){for(var s in stores){if(stores[s].reset){stores[s].reset();}}}},persist:function(storeName){CQ_Analytics.ClientContextMgr.ServerStorage.post(storeName,true);}}}();window.ClientContext=CQ_Analytics.ClientContext;window.ContextCloud=CQ_Analytics.ClientContext;}
if(CQ_Analytics&&!CQ_Analytics.TwitterProfileDataMgr){CQ_Analytics.TwitterProfileDataMgr=function(){};CQ_Analytics.TwitterProfileDataMgr.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.TwitterProfileDataMgr.prototype.STOREKEY="TWITTERPROFILEDATA";CQ_Analytics.TwitterProfileDataMgr.prototype.STORENAME="twitterprofile";CQ_Analytics.TwitterProfileDataMgr.prototype.clear=function(){this.data=null;this.initProperty={};};CQ_Analytics.TwitterProfileDataMgr.prototype.init=function(){if(!this.data){this.data={};for(var p in this.initProperty){this.data[p]=this.initProperty[p];}}};CQ_Analytics.TwitterProfileDataMgr.prototype.getLoaderURL=function(){return CQ_Analytics.ClientContextMgr.getClientContextURL("/contextstores/twitterprofiledata/loader.json");};CQ_Analytics.TwitterProfileDataMgr.prototype.loadProfile=function(authorizableId){CQ_Analytics.TwitterProfileDataMgr.lastUid=authorizableId;var url=this.getLoaderURL();url=CQ_Analytics.Utils.addParameter(url,"authorizableId",authorizableId);try{var object=CQ.shared.HTTP.eval(url);if(object){this.data={};for(var p in object){this.data[p]=object[p];}
this.fireEvent("update");if(CQ_Analytics.ClickstreamcloudEditor){CQ_Analytics.ClickstreamcloudEditor.reload();}
return true;}}catch(error){if(console&&console.log)console.log("Error during profile loading",error);}
return false;};CQ_Analytics.TwitterProfileDataMgr=new CQ_Analytics.TwitterProfileDataMgr();CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);},CQ_Analytics.TwitterProfileDataMgr);}
if(!CQ_Analytics.FacebookProfileDataMgr){CQ_Analytics.FacebookProfileDataMgr=function(){};CQ_Analytics.FacebookProfileDataMgr.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.FacebookProfileDataMgr.prototype.STOREKEY="FBPROFILEDATA";CQ_Analytics.FacebookProfileDataMgr.prototype.STORENAME="facebookprofile";CQ_Analytics.FacebookProfileDataMgr.prototype.clear=function(){this.data=null;this.initProperty={};};CQ_Analytics.FacebookProfileDataMgr.prototype.init=function(){if(!this.data){this.data={};for(var p in this.initProperty){this.data[p]=this.initProperty[p];}}};CQ_Analytics.FacebookProfileDataMgr.prototype.getLoaderURL=function(){return CQ_Analytics.ClientContextMgr.getClientContextURL("/contextstores/fbprofiledata/loader.json");};CQ_Analytics.FacebookProfileDataMgr.prototype.loadProfile=function(authorizableId){CQ_Analytics.FacebookProfileDataMgr.lastUid=authorizableId;var url=this.getLoaderURL();url=CQ_Analytics.Utils.addParameter(url,"authorizableId",authorizableId);try{var object=CQ.shared.HTTP.eval(url);if(object){this.data={};for(var p in object){this.data[p]=object[p];}
this.fireEvent("update");this.fireEvent("checkBirthday");if(CQ_Analytics.ClickstreamcloudEditor){CQ_Analytics.ClickstreamcloudEditor.reload();}
return true;}}catch(error){if(console&&console.log)console.log("Error during profile loading",error);}
return false;};CQ_Analytics.FacebookProfileDataMgr=new CQ_Analytics.FacebookProfileDataMgr();CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);},CQ_Analytics.FacebookProfileDataMgr);}
if(!CQ_Analytics.FacebookInterestsMgr){CQ_Analytics.FacebookInterestsMgr=function(){};CQ_Analytics.FacebookInterestsMgr.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.FacebookInterestsMgr.prototype.STOREKEY="FBINTERESTSDATA";CQ_Analytics.FacebookInterestsMgr.prototype.STORENAME="fbinterests";CQ_Analytics.FacebookInterestsMgr.prototype.getLabel=function(name){return name;};CQ_Analytics.FacebookInterestsMgr.prototype.getLink=function(name){return"";};CQ_Analytics.FacebookInterestsMgr.prototype.clear=function(){this.data=null;this.initProperty={};};CQ_Analytics.FacebookInterestsMgr.prototype.getLoaderURL=function(){return CQ_Analytics.ClientContextMgr.getClientContextURL("/contextstores/fbinterestsdata/loader.json");};CQ_Analytics.FacebookInterestsMgr.prototype.loadProfile=function(authorizableId){if(authorizableId){var url=this.getLoaderURL();url=CQ_Analytics.Utils.addParameter(url,"authorizableId",authorizableId);CQ_Analytics.FacebookInterestsMgr.lastUid=authorizableId;try{var object=CQ.shared.HTTP.eval(url);if(object){this.data={};for(var p in object){this.data[p]=object[p];}
if(CQ_Analytics.ClickstreamcloudEditor){CQ_Analytics.ClickstreamcloudEditor.reload();}
return true;}}catch(error){if(console&&console.log)console.log("Error during profile loading",error);}}
return false;};CQ_Analytics.FacebookInterestsMgr=new CQ_Analytics.FacebookInterestsMgr();CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);},CQ_Analytics.FacebookInterestsMgr);}
if(!CQ_Analytics.ViewedProducts){CQ_Analytics.ViewedProducts=function(){this.data=null;this.MAX_COUNT=20;};CQ_Analytics.ViewedProducts.prototype=new CQ_Analytics.PersistedSessionStore();CQ_Analytics.ViewedProducts.prototype.STOREKEY="VIEWEDPRODUCTS";CQ_Analytics.ViewedProducts.prototype.STORENAME="viewedproducts";CQ_Analytics.ViewedProducts.prototype.record=function(path,title,image){if(!this.data){this.init();}
for(var i=0;i<this.data.length;i++){if(this.data[i].path==path){this.data.splice(i,1);break;}}
if(this.data.length==this.MAX_COUNT){this.data.shift();}
this.data.push({'path':path,'title':title,'image':image});this.persist();this.fireEvent("update");}
CQ_Analytics.ViewedProducts.prototype.mostRecent=function(){if(!this.data){this.init();}
if(this.data.length>0){return this.data[this.data.length-1];}else{return null;}}
CQ_Analytics.ViewedProducts.prototype.mostRecentNotInCart=function(){if(!this.data){this.init();}
if(!CQ_Analytics.CartMgr){return this.mostRecent();}
for(var i=this.data.length-1;i>=0;i--){var candidate=this.data[i];if(!CQ_Analytics.CartHelper.containsProduct(CQ_Analytics.CartMgr.getData(),candidate.path,1)){return candidate;}}
return null;}
CQ_Analytics.ViewedProducts.prototype.getData=function(excluded){if(!this.data){this.init();}
return this.data;};CQ_Analytics.ViewedProducts.prototype.init=function(){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});var value=store.get(this.getStoreKey());value=value===null?"":new String(value);var products=value.split(";");this.data=[];for(var i=0;i<products.length;i++){var fields=products[i].split(",");if(fields.length>=3){this.data.push({'path':fields[0],'title':fields[1],'image':fields[2]});}}
this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.ViewedProducts.prototype.persist=function(){if(this.fireEvent("beforepersist")!==false){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});var products=[];for(var i=0;i<this.data.length;i++){var product=this.data[i];products.push(product.path+","+product.title+","+product.image);}
store.set(this.getStoreKey(),products.join(";"));this.fireEvent("persist");}};CQ_Analytics.ViewedProducts.prototype.reset=function(){this.clear();this.fireEvent("update");};CQ_Analytics.ViewedProducts.prototype.clear=function(){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});store.remove(this.getStoreKey());this.data=[];};CQ_Analytics.ViewedProducts=new CQ_Analytics.ViewedProducts();CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);},CQ_Analytics.ViewedProducts);}
if(!CQ_Analytics.TagCloudMgr){CQ_Analytics.TagCloudMgr=function(){this.data=null;this.addedTags={};this.frequencies=null;this.initialTags=null;this.initialAddedTags={};this.copyObject=function(from){var to={};for(var p in from){to[p]=from[p];}
return to;};};CQ_Analytics.TagCloudMgr.prototype=new CQ_Analytics.PersistedSessionStore();CQ_Analytics.TagCloudMgr.prototype.STOREKEY="TAGCLOUD";CQ_Analytics.TagCloudMgr.prototype.STORENAME="tagcloud";CQ_Analytics.TagCloudMgr.prototype.parseTagList=function(taglist){var tags={};var tagArray=taglist.split(",");for(var t in tagArray){if(tagArray.hasOwnProperty(t)){var entry=tagArray[t].split("=");if(entry.length==2){tags[entry[0]]=parseInt(entry[1]);}}}
return tags;};CQ_Analytics.TagCloudMgr.prototype.parseString=function(taglist){this.data=this.parseTagList(taglist);return this;};CQ_Analytics.TagCloudMgr.prototype.add=function(tag){this.addedTags[tag]=true;this.data[tag]=(this.data[tag]||0)+1;};CQ_Analytics.TagCloudMgr.prototype.each=function(func){for(var t in this.data){if(this.data.hasOwnProperty(t)){func(t,this.data[t]);}}};CQ_Analytics.TagCloudMgr.prototype.calculateFrequencies=function(){var freqSet={};var freqArray=[];this.each(function(tag,count){if(!freqSet[count]){freqArray.push(count);}
freqSet[count]=true;});freqArray.sort(function compareNumbers(a,b){if(a>b)
return 1;if(a<b)
return-1;return 0;});return freqArray;};CQ_Analytics.TagCloudMgr.prototype.calculateNtile=function(frequency,n){if(this.frequencies===null){this.frequencies=this.calculateFrequencies();}
var i=0;while(true){if((i>=(this.frequencies.length-1))||(this.frequencies[i]>=frequency)){return Math.ceil((i+1)/this.frequencies.length*n);}
i++;}};CQ_Analytics.TagCloudMgr.prototype.getTags=function(){return this.data;};CQ_Analytics.TagCloudMgr.prototype.getData=function(excluded){return this.getTags();};CQ_Analytics.TagCloudMgr.prototype.getTag=function(tag){return this.data[tag]>0?this.data[tag]:0;};CQ_Analytics.TagCloudMgr.prototype.init=function(pageTags){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});var value=store.get(this.getStoreKey());value=value===null?"":new String(value);this.data=this.parseTagList(value);if(pageTags){for(var i in pageTags){if(pageTags.hasOwnProperty(i)){this.add(pageTags[i]);}}}
this.initialTags=this.copyObject(this.data);this.initialAddedTags=this.copyObject(this.addedTags);this.persist();this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.TagCloudMgr.prototype.setProperty=function(tag,value){if(this.data==null){this.init();}
if(value>0){this.addedTags[tag]=true;this.data[tag]=value>0?value:0;}else{delete this.addedTags[tag];delete this.data[tag];}
this.persist();this.fireEvent("update");};CQ_Analytics.TagCloudMgr.prototype.reset=function(){this.clear();this.fireEvent("update");};CQ_Analytics.TagCloudMgr.prototype.getProperty=function(tag){if(this.data==null){this.init();}
return this.data[tag]>0?this.data[tag]:0;};CQ_Analytics.TagCloudMgr.prototype.removeProperty=function(tag){if(this.data==null){this.init();}
this.setProperty(tag,0);};CQ_Analytics.TagCloudMgr.prototype.clear=function(){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});store.remove(this.getStoreKey());this.addedTags={};this.data={};};CQ_Analytics.TagCloudMgr.prototype.getLink=function(name){return"";};CQ_Analytics.TagCloudMgr.prototype.getLabel=function(name){if(name){var namespaceSplit=name.split(":");var pathSplit=namespaceSplit[namespaceSplit.length-1].split("/");name=pathSplit[pathSplit.length-1];}
return name;};CQ_Analytics.TagCloudMgr=new CQ_Analytics.TagCloudMgr();CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);},CQ_Analytics.TagCloudMgr);}
if(!CQ_Analytics.SurferInfoMgr){CQ_Analytics.SurferInfoMgr=function(){};CQ_Analytics.SurferInfoMgr.prototype=new CQ_Analytics.SessionStore();CQ_Analytics.SurferInfoMgr.prototype.STOREKEY="SURFERINFO";CQ_Analytics.SurferInfoMgr.prototype.STORENAME="surferinfo";CQ_Analytics.SurferInfoMgr.prototype.init=function(){this.data={};for(var p in this.initProperty){this.data[p]=this.initProperty[p];}
this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.SurferInfoMgr.prototype.clear=function(){this.data=null;this.initProperty={};};CQ_Analytics.SurferInfoMgr.prototype.getLabel=function(name){return name;};CQ_Analytics.SurferInfoMgr.prototype.getLink=function(name){return"";};CQ_Analytics.SurferInfoMgr=new CQ_Analytics.SurferInfoMgr();CQ_Analytics.CCM.addListener("configloaded",function(){var bi=CQ_Analytics.BrowserInfoInstance;this.addInitProperty("browserFamily",bi.getBrowserFamily());this.addInitProperty("browserVersion",bi.getBrowserVersion());this.addInitProperty("browser","${/surferinfo/browserFamily} ${/surferinfo/browserVersion}");this.addInitProperty("OS",bi.getOSName());this.addInitProperty("resolution",bi.getScreenResolution());this.addInitProperty("device",bi.getDeviceType());this.addInitProperty("isMobile",bi.isMobile());this.addInitProperty("userAgent",bi.getUserAgent());var today=new Date();this.addInitProperty("day",today.getDate());this.addInitProperty("month",today.getMonth()+1);this.addInitProperty("year",today.getFullYear());this.addInitProperty("hours",today.getHours());this.addInitProperty("minutes",today.getMinutes());var image="${/surferinfo/browserFamily}";if(bi.isMobile()){image="${/surferinfo/device}";}
this.addInitProperty("image",image);var thumbnail=CQ_Analytics.ClientContextMgr.getClientContextURL("/contextstores/surferinfo/resources/${/surferinfo/image}.png");this.addInitProperty("thumbnail",thumbnail);if(CQ_Analytics.MousePositionMgr){CQ_Analytics.MousePositionMgr.addListener("update",function(){this.setProperty("mouse X",CQ_Analytics.MousePositionMgr.getProperty("x"));this.setProperty("mouse Y",CQ_Analytics.MousePositionMgr.getProperty("y"));},this);}
this.addListener("update",function(){var deviceType=this.getProperty("device");var image="${/surferinfo/browserFamily}";if(bi.isMobile(deviceType)){image="${/surferinfo/device}";}
var currentImage=this.getProperty("image");if(currentImage!=image){this.setProperty("image",image);}},this);CQ_Analytics.CCM.register(this);},CQ_Analytics.SurferInfoMgr);}
if(!CQ_Analytics.SocialGraphMgr){CQ_Analytics.SocialGraphMgr=CQ_Analytics.JSONPStore.registerNewInstance("socialgraph");CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);CQ_Analytics.ProfileDataMgr.addListener("update",function(){var uid=CQ_Analytics.ProfileDataMgr.getProperty("authorizableId");if(uid!=this.lastUid){this.fireEvent("update");}},CQ_Analytics.SocialGraphMgr);},CQ_Analytics.SocialGraphMgr);}
if(CQ_Analytics.SegmentMgr&&!CQ_Analytics.SegmentMgr.isResolvedRegistered){CQ_Analytics.SegmentMgr.isResolvedRegistered=true;CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.StoreRegistry.register(CQ_Analytics.SegmentMgr);CQ_Analytics.CCM.fireEvent("storeregister",CQ_Analytics.SegmentMgr);},CQ_Analytics.SegmentMgr);}
if(!CQ_Analytics.ProfileDataMgr){CQ_Analytics.ProfileDataMgr=function(){this.addListener("beforepersist",function(){this.checkAuthorizableId();},this);};CQ_Analytics.ProfileDataMgr.prototype=new CQ_Analytics.PersistedSessionStore();CQ_Analytics.ProfileDataMgr.prototype.STOREKEY="PROFILEDATA";CQ_Analytics.ProfileDataMgr.prototype.STORENAME="profile";CQ_Analytics.ProfileDataMgr.prototype.LOADER_PATH=CQ_Analytics.Utils.externalize("/libs/cq/personalization/components/profileloader/content/load.js",true);CQ_Analytics.ProfileDataMgr.prototype.PROFILE_LOADER=CQ_Analytics.Utils.externalize("/libs/cq/personalization/components/profileloader/content/load.json",true);CQ_Analytics.ProfileDataMgr.prototype.init=function(){this.persistence=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});$CQ(CQ.shared.ClientSidePersistence).bind(CQ.shared.ClientSidePersistence.EVENT_NAME,function(event,data){if(!data){return;}
if(((data.key==='CLIENTCONTEXT')||(data.key==='PROFILEDATA'))&&(data.mode!=CQ.shared.ClientSidePersistence.MODE_COOKIE.name)){var replicate=new CQ.shared.ClientSidePersistence({'container':'','mode':CQ.shared.ClientSidePersistence.MODE_COOKIE});var value=replicate.get(data.key);if(data.key==='PROFILEDATA'&&(!value||value=="")){CQ.shared.ClientSidePersistence.clearAllMaps();}
replicate.set(data.key,data.value);}});var value=this.persistence.get(this.getStoreKey());if(!value||value==""){this.data={};for(var p in this.initProperty){this.data[p]=this.initProperty[p];}}else{this.data=this.parse(value);}
this.persist();this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.ProfileDataMgr.prototype.checkAuthorizableId=function(){if(!this.data){this.init();}
if(this.data["authorizableId"]){CQ_Analytics.CCM.setVisitorId(this.data["authorizableId"]);}else{CQ_Analytics.CCM.setVisitorId("");}};CQ_Analytics.ProfileDataMgr.prototype.getLabel=function(name){return name;};CQ_Analytics.ProfileDataMgr.prototype.getLink=function(name){return"";};CQ_Analytics.ProfileDataMgr.prototype.clear=function(){if(this.persistence){this.persistence.remove(this.getStoreKey());}
this.data=null;this.initProperty={};};CQ_Analytics.ProfileDataMgr.prototype.getLoaderURL=function(){return CQ_Analytics.ClientContextMgr.getClientContextURL("/contextstores/profiledata/loader.json");};CQ_Analytics.ProfileDataMgr.prototype.loadProfile=function(authorizableId){var url=this.getLoaderURL();url=CQ_Analytics.Utils.addParameter(url,"authorizableId",authorizableId);try{var object=CQ.shared.HTTP.eval(url);if(object){this.data={};for(var p in object){this.data[p]=object[p];}
this.persist();this.fireEvent("initialize",this);this.fireEvent("update");if(CQ_Analytics.ClickstreamcloudEditor){CQ_Analytics.ClickstreamcloudEditor.reload();}
return true;}}catch(error){if(console&&console.log)console.log("Error during profile loading",error);}
return false;};CQ_Analytics.ProfileDataMgr=new CQ_Analytics.ProfileDataMgr();CQ_Analytics.CCM.addListener("configloaded",function(){this.checkAuthorizableId();this.addListener("update",function(event,property){if(property=="birthday"||!property){var birthday=this.getProperty("birthday");var age=this.getProperty("age");var newAge="";if(birthday){try{var getDaysBetween=function(d1,d2){var tmp=new Date(d2.getTime());tmp.setUTCHours(d1.getUTCHours(),d1.getUTCMinutes(),d1.getUTCSeconds(),d1.getUTCMilliseconds());var time=tmp.getTime()-d1.getTime();return time/(1000*60*60*24);};var getDayOfYear=function(dob){var start=new Date(dob.getFullYear(),0,0);return getDaysBetween(dob,start)*-1;};var dob=new Date(Date.parse(birthday));if(!isNaN(dob.getTime())){var today=new Date();if(getDayOfYear(dob)==getDayOfYear(today)&&dob.getMonth()==today.getMonth()){newAge=CQ.shared.HTTP.externalize(CQ_Analytics.ClientContextMgr.getClientContextURL("/contextstores/profiledata/resources/birthday_cake.png"));}else{var yearDiff=today.getFullYear()-dob.getFullYear();if(getDayOfYear(dob)>getDayOfYear(today)){newAge=yearDiff;}else{newAge=Math.max(0,yearDiff-1);}}}else{newAge="";}}catch(error){newAge="";}}
if(age!=newAge){this.setProperty("age",newAge);}}});CQ_Analytics.CCM.register(this);},CQ_Analytics.ProfileDataMgr);}
if(!CQ_Analytics.GeolocationUtils){CQ_Analytics.GeolocationUtils=new function(){return{init:function(storeName){var geoloc;try{if(typeof navigator.geolocation==='undefined'){geoloc=google.gears.factory.create('beta.geolocation');}else{geoloc=navigator.geolocation;}}catch(e){}
var createStore=function(defaultData){var store=CQ_Analytics.PersistedJSONStore.registerNewInstance(storeName,defaultData);store.addListener("update",function(event,property){var latitude=CQ_Analytics.ClientContext.get(storeName+"/latitude");var longitude=CQ_Analytics.ClientContext.get(storeName+"/longitude");if(!latitude||!longitude){if(property!="generatedThumbnail"){store.setProperty("generatedThumbnail",CQ_Analytics.GeolocationUtils.THUMBNAILS.fallback);}else{if(store.getProperty(property,true)!=CQ_Analytics.GeolocationUtils.THUMBNAILS.fallback){store.setProperty(property,CQ_Analytics.GeolocationUtils.THUMBNAILS.fallback);}}}else{if(store.getProperty("generatedThumbnail",true)==CQ_Analytics.GeolocationUtils.THUMBNAILS.fallback){store.setProperty("generatedThumbnail",store.getInitProperty("generatedThumbnail"));}
if(property=="latitude"||property=="longitude"||!property){CQ_Analytics.GeolocationUtils.computeAddress(latitude,longitude,storeName);}}});};var initGeolocationStore=function(data,skipValues){var store=CQ_Analytics.StoreRegistry.getStore(storeName);if(store){data=data||CQ_Analytics.GeolocationUtils.DEFAULTS;var gt=data["generatedThumbnail"]=store.getInitProperty("generatedThumbnail");store.initJSON(data);if(!skipValues){store.init();store.setProperty("generatedThumbnail",gt);}}else{createStore(data);}};createStore();if(geoloc){geoloc.getCurrentPosition(function(data){var d={"longitude":data.coords.longitude,"latitude":data.coords.latitude};if(data.address){d["address"]=data.address}
initGeolocationStore(d,CQ_Analytics.CCM.areStoresInitialized);},function(error){if(!CQ_Analytics.CCM.areStoresInitialized){var msg="Error";if(CQ_Analytics.isUIAvailable){msg=CQ.I18n.getMessage("Connection timeout",null,"timeout while connecting geolocation service");if(error.code==1){msg=CQ.I18n.getMessage("Permission denied",null,"permission denied message from goelocation service");}else{if(error.code==2){msg=CQ.I18n.getMessage("Position unavailable",null,"geolocation service couldn't find location");}}}
var d={"address":{"country":msg}};initGeolocationStore(d,CQ_Analytics.CCM.areStoresInitialized);}});}else{initGeolocationStore();}},computeAddress:function(lat,lng,storeName){CQ_Analytics.ClientContext.set(storeName+"/address/region");CQ_Analytics.ClientContext.set(storeName+"/address/countryCode");CQ_Analytics.ClientContext.set(storeName+"/address/country");var geocode_callback=function(){var point=new google.maps.LatLng(lat,lng);var geocoder=new google.maps.Geocoder();geocoder.geocode({location:point},function(result,status){if(status==="OK"&&result[0]&&result[0].address_components){for(var i=0;i<result[0].address_components.length;i++){var a=result[0].address_components[i];if(a.types&&a.types.length){if(a.types[0]=="administrative_area_level_1"){CQ_Analytics.ClientContext.set(storeName+"/address/region",a["short_name"]);}else{if(a.types[0]=="country"){CQ_Analytics.ClientContext.set(storeName+"/address/countryCode",a["short_name"]);CQ_Analytics.ClientContext.set(storeName+"/address/country",a["long_name"]);}}}}}});};if(!window.google){window.geocode_callback=geocode_callback;$CQ.getScript(document.location.protocol+"//maps.google.com/maps/api/js?sensor=false&callback=geocode_callback");}else{geocode_callback.call();}}}}();CQ_Analytics.GeolocationUtils.DEFAULTS={"latitude":37.331375,"longitude":-121.893992};CQ_Analytics.GeolocationUtils.THUMBNAILS={"fallback":document.location.protocol+"//maps.googleapis.com/maps/api/staticmap?center=37,-121&zoom=0&size=80x80&sensor=false"}}
if(!CQ_Analytics.CartMgr){CQ_Analytics.CartMgr=new CQ_Analytics.SessionStore();CQ_Analytics.CartMgr.STOREKEY="CART";CQ_Analytics.CartMgr.STORENAME="cart";CQ_Analytics.CartMgr.init=function(){if(!this.data){this.data={};}else{var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});var simulationString=store.get(this.STOREKEY);if(simulationString){var referenceAndTotal=simulationString.split("=");if(referenceAndTotal.length>=2){this.referenceTotalPrice=referenceAndTotal[0];this.simulatedTotalPrice=referenceAndTotal[1];this.updateSimulatedPrice();}}
this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");}};CQ_Analytics.CartMgr.persist=function(){if(this.fireEvent("beforepersist")!==false){var store=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});var simulationString=null;if(this.referenceTotalPrice&&this.simulatedTotalPrice){simulationString=this.referenceTotalPrice+"="+this.simulatedTotalPrice;}
store.set(this.STOREKEY,simulationString);this.fireEvent("persist");}};CQ_Analytics.CartMgr.updateSimulatedPrice=function(){if(this.simulatedTotalPrice&&this.referenceTotalPrice==this.data["totalPriceFloat"]){this.data["totalPrice"]=this.simulatedTotalPrice+"";this.data["totalPriceFloat"]=this.simulatedTotalPrice;}else{this.simulatedTotalPrice=null;this.persist();}};CQ_Analytics.CartMgr.registerSimulatedPrice=function(value){if(this.simulatedTotalPrice){this.simulatedTotalPrice=value;this.data["totalPrice"]=value+"";}else{this.referenceTotalPrice=this.data["totalPriceFloat"];this.simulatedTotalPrice=value;}
this.persist();};CQ_Analytics.CartMgr.getProperty=function(name,raw){if(!this.data){this.init();}
var obj=this.data;try{var parts=name.split(".");for(var i=0;i<parts.length-1;i++){var part=parts[i];var indexPos=part.indexOf("[");var index=-1;if(indexPos>0){index=parseInt(part.substring(indexPos+1,part.length-1));part=part.substring(0,indexPos);}
obj=obj[part];if(index>=0){obj=obj[index];}}
var finalPart=parts[parts.length-1];if(!raw){var xssName=CQ.shared.XSS.getXSSPropertyName(finalPart);if(obj[xssName]){return obj[xssName];}}
return obj[finalPart];}catch(e){return undefined;}};CQ_Analytics.CartMgr.validate=function(name,value){if(name=="totalPriceFloat"){var price=parseFloat(value);return price>=0;}else if(name.indexOf(".quantity")>0){var quantity=parseInt(value);return quantity>=0;}
return true;}
CQ_Analytics.CartMgr.setProperty=function(name,value){if(!this.data){this.init();}
if(!this.validate(name,value)){this.fireEvent("update",name);return;}
if(name=="totalPriceFloat"){this.registerSimulatedPrice(value);}
var obj=this.data;var parts=name.split(".");for(var i=0;i<parts.length-1;i++){var part=parts[i];var indexPos=part.indexOf("[");var index=-1;if(indexPos>0){index=parseInt(part.substring(indexPos+1,part.length-1));part=part.substring(0,indexPos);}
if(!obj[part]){obj[part]={};}
obj=obj[part];if(index>=0){if(!obj[index]){obj[index]={};}
obj=obj[index];}}
var finalPart=parts[parts.length-1];obj[finalPart]=value;var xssName=CQ.shared.XSS.getXSSPropertyName(finalPart);this.data[xssName]=CQ.shared.XSS.getXSSValue(value);this.fireEvent("update",name);};CQ_Analytics.CartMgr.update=function(){var store=this;if(this.updateUrl){$CQ.ajax({url:this.updateUrl,type:"POST",data:{"cart":JSON.stringify(store.data)},externalize:false,encodePath:false,hook:true,success:function(jsonData){store.data=jsonData;store.updateSimulatedPrice();CQ_Analytics.ClientContextUtils.renderStore(CQ_Analytics.CartMgr.divId,CQ_Analytics.CartMgr.STORENAME);store.fireEvent("updatecomplete");store.fireEvent("update");}});}};CQ_Analytics.CartMgr.clear=function(){if(this.data["entries"]){this.data["entries"]=[];}
if(this.data["vouchers"]){this.data["vouchers"]=[];}
this.data["totalPrice"]="0";this.referenceTotalPrice=null;this.simulatedTotalPrice=null;};CQ_Analytics.CartMgr.reset=function(){this.clear();this.fireEvent("update");this.persist();this.update();}
CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);CQ_Analytics.SegmentMgr.addListener("update",function(){if(!this.promotionsMap){return;}
if(!this.data.promotions){this.data.promotions=[];}
var resolvedSegments=CQ_Analytics.SegmentMgr.getResolved();var resolvedPromoPaths=[];for(var i=0;i<this.promotionsMap.length;i++){var testPromotionMap=this.promotionsMap[i];var resolved=false;var testSegments=testPromotionMap.segments.split(",");for(var j=0;j<testSegments.length;j++){if($CQ.inArray(testSegments[j],resolvedSegments)>=0){resolved=true;break;}}
if(resolved){resolvedPromoPaths.push(testPromotionMap.path);}}
var changed=false;for(var i=0;i<this.data.promotions.length;i++){var promo=this.data.promotions[i];var j=$CQ.inArray(promo["path"],resolvedPromoPaths);if(j>=0){resolvedPromoPaths.splice(j,1);}else{this.data.promotions.splice(i--,1);changed=true;}}
for(var i=0;i<resolvedPromoPaths.length;i++){var promo={"path":resolvedPromoPaths[i]};this.data.promotions.push(promo);changed=true;}
if(changed){this.update();}},CQ_Analytics.CartMgr);},CQ_Analytics.CartMgr);}
if(!CQ_Analytics.CartHelper){CQ_Analytics.CartHelper=(function(){return{containsProduct:function(data,product,quantity){var productPagePath=product?product.substring(0,product.lastIndexOf("#")):null;for(var i=0;data.entries&&i<data.entries.length;i++){var entry=data.entries[i];var entryPagePath=entry.page.substring(0,entry.page.lastIndexOf("#"));if((!product||entryPagePath==productPagePath)&&(!quantity||entry.quantity>=quantity)){return true;}}
return false;}};})();}
if(!CQ_Analytics.CampaignMgr){CQ_Analytics.CampaignMgr=function(){};CQ_Analytics.CampaignMgr.prototype=new CQ_Analytics.PersistedSessionStore();CQ_Analytics.CampaignMgr.prototype.STOREKEY="CAMPAIGN";CQ_Analytics.CampaignMgr.prototype.STORENAME="campaign";CQ_Analytics.CampaignMgr.prototype.DEFAULT_EXPERIENCE="DEFAULT";CQ_Analytics.CampaignMgr.prototype.init=function(){var p;this.persistence=new CQ_Analytics.SessionPersistence({'container':'ClientContext'});var value=this.persistence.get(this.getStoreKey());if(!this.data){this.data={};}
if(!value||value===""){for(p in this.initProperty){if(this.initProperty.hasOwnProperty(p)){this.data[p]=this.initProperty[p];}}}else{this.data=this.parse(value);var campaigns=this.getInitProperty('campaigns');if(campaigns){this.data.campaigns=campaigns;}}
this.validate();this.persist();this.initialized=true;this.fireEvent("initialize",this);this.fireEvent("update");};CQ_Analytics.CampaignMgr.prototype.validate=function(){if(this.data.campaigns){if(!this.getCampaignBy("path",this.data.path)&&!this.getCampaignBy("id",this.data.id)){this.setCampaign(null);}
if(this.data["recipe/path"]!==CQ_Analytics.CampaignMgr.DEFAULT_EXPERIENCE){if(!this.getExperienceBy("path",this.data["recipe/path"])&&!this.getExperienceBy("id",this.data["recipe/id"])){this.setExperience(null);}}}};CQ_Analytics.CampaignMgr.prototype.getCampaignBy=function(prop,value){if(!this.data||!this.data.campaigns){return null;}
var i,campaigns=this.data.campaigns;for(i=0;i<campaigns.length;i++){var campaign=campaigns[i];if(campaign[prop]===value){return campaign;}}
return null;};CQ_Analytics.CampaignMgr.prototype.getExperienceBy=function(prop,value){if(!this.data||!this.data.campaigns){return null;}
var i,campaigns=this.data.campaigns;for(i=0;i<campaigns.length;i++){var campaign=campaigns[i];for(var j=0;j<campaign.experiences.length;j++){var experience=campaign.experiences[j];if(experience[prop]===value){return experience;}}}
return null;};CQ_Analytics.CampaignMgr.prototype.setCampaign=function(campaign){this.setProperties({'name':campaign?campaign.title:"",'path':campaign?campaign.path:"",'id':campaign?campaign.id:"",'recipe/name':campaign?CQ.I18n.getMessage("(default)"):"",'recipe/path':campaign?this.DEFAULT_EXPERIENCE:"",'recipe/id':campaign?this.DEFAULT_EXPERIENCE:""});};CQ_Analytics.CampaignMgr.prototype.setExperience=function(experience){this.setProperties({'recipe/name':experience?experience.title:"",'recipe/path':experience?experience.path:"",'recipe/id':experience?experience.id:""});};CQ_Analytics.CampaignMgr.prototype.setProperty=function(name,value){if(name==="id"||name==="path"){this.setCampaign(this.getCampaignBy(name,value));return;}else if(name==="recipe/id"||name==="recipe/path"){if(value!==CQ_Analytics.CampaignMgr.DEFAULT_EXPERIENCE){this.setExperience(this.getExperienceBy(name.substring("recipe/".length),value));return;}}
CQ_Analytics.PersistedSessionStore.prototype.setProperty.call(this,name,value);};CQ_Analytics.CampaignMgr.prototype.isCampaignSelected=function(){return this.getProperty("path")!=='';};CQ_Analytics.CampaignMgr.prototype.clear=function(){this.data=null;this.initProperty={};};CQ_Analytics.CampaignMgr.prototype.getLabel=function(name){return name;};CQ_Analytics.CampaignMgr.prototype.getLink=function(name){return"";};CQ_Analytics.CampaignMgr=new CQ_Analytics.CampaignMgr();CQ_Analytics.CCM.addListener("configloaded",function(){CQ_Analytics.CCM.register(this);},CQ_Analytics.CampaignMgr);}
if(!CQ_Analytics.ActivityStreamMgr){CQ_Analytics.ActivityStreamMgr=CQ_Analytics.JSONStore.registerNewInstance("activitystream",{});CQ_Analytics.ActivityStreamMgr.internalRenderer=function(profilePath,divId){var url=profilePath+".form.html";url+=CQ_Analytics.ClientContextMgr.getClientContextURL("/contextstores/activitystream.html");url+="?limit=3";CQ.shared.HTTP.get(url,function(options,success,response){$CQ("#"+divId).children().remove();if(success){$CQ("#"+divId).append(response.body);}});};CQ_Analytics.ActivityStreamMgr.renderer=function(activityStore,divId){if(!activityStore.isReady){activityStore.isReady=true;CQ_Analytics.ClientContextUtils.onStoreRegistered("profile",function(profileStore){profileStore.addListener("update",function(event,path){var profilePath=this.getProperty("path");if(profilePath!=CQ_Analytics.ActivityStreamMgr.currentProfilePath){CQ_Analytics.ActivityStreamMgr.currentProfilePath=profilePath;CQ_Analytics.ActivityStreamMgr.internalRenderer(profilePath,divId);}},profileStore);var profilePath=profileStore.getProperty("path");CQ_Analytics.ActivityStreamMgr.currentProfilePath=profilePath;CQ_Analytics.ActivityStreamMgr.internalRenderer(profilePath,divId);});}
return"";}}